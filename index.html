<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>现地计划书</title>
<style>
  
:root{
  --bg:#07070a;
  --panel:#0c0c12;
  --panel2:#0f1018;
  --text:#f3f4f6;
  --muted:rgba(255,255,255,.65);
  --muted2:rgba(255,255,255,.45);
  --line:rgba(255,255,255,.12);
  --line2:rgba(255,255,255,.18);
  --accent:#7c3aed;
  --accent2:#22c55e;
  --danger:#ef4444;
  --shadow:0 14px 40px rgba(0,0,0,.55);
  --shadow2:0 10px 24px rgba(0,0,0,.45);
  --r:16px;
  --r2:22px;
  --pad:14px;
  --pad2:18px;
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
}

html,body{ height:100%; }
body{
  margin:0;
  background:
    radial-gradient(1200px 600px at 20% -10%, rgba(124,58,237,.25), transparent 55%),
    radial-gradient(900px 500px at 90% 0%, rgba(34,197,94,.18), transparent 60%),
    var(--bg);
  color:var(--text);
  font-family:var(--font);
}

a{ color:inherit; }

:root{
    --bg:#0b0c0f;
    --panel:#0f1117;
    --panel2:#0c0e14;
    --text:#e9eef8;
    --muted:rgba(233,238,248,.65);
    --line:rgba(233,238,248,.12);
    --line2:rgba(233,238,248,.18);
    --pill:#000;
    --shadow: 0 8px 30px rgba(0,0,0,.35);
    --r:18px;
    --r2:999px;
    --gap:14px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
  }
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 20% 0%, #101424 0%, rgba(16,20,36,0) 55%), var(--bg); color:var(--text); font-family:var(--sans);}
  a{color:inherit}
  .wrap{max-width:1180px; margin:0 auto; padding:18px 14px 40px;}
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:14px; margin-bottom:14px;}
  .brand{display:flex; align-items:center; gap:12px;}
  .avatar{width:42px;height:42px;border-radius:50%; overflow:hidden; border:1px solid var(--line2); background:#111; box-shadow:var(--shadow);}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .brand .t{display:flex;flex-direction:column;line-height:1.05}
  .brand .t b{font-size:15px}
  .brand .t span{font-size:12px;color:var(--muted)}
  .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .btn{appearance:none;border:1px solid var(--line2); background:rgba(255,255,255,.04); color:var(--text); padding:8px 10px;border-radius:12px; cursor:pointer; font-size:12px;}
  .btn:hover{border-color:rgba(233,238,248,.28)}
  .btn.primary{background:rgba(59,130,246,.18); border-color:rgba(59,130,246,.45)}
  .btn.ghost{background:transparent}
  .btn.danger{background:rgba(239,68,68,.15); border-color:rgba(239,68,68,.38)}
  .grid{display:grid; gap:var(--gap);}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow);}
  .panel .hd{padding:12px 12px 0; display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .panel .hd b{font-size:13px}
  .panel .hd .hint{font-size:12px;color:var(--muted)}
  .panel .bd{padding:12px}
  .formGrid{display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:10px; align-items:end;}
  .field{display:flex; flex-direction:column; gap:6px; min-width:0;}
  .label{font-size:11px;color:var(--muted)}
  input, select, textarea{width:100%; box-sizing:border-box; background:#000; color:var(--text); border:1px solid var(--line2); border-radius:12px; padding:8px 10px; font-size:12px; outline:none;}
  textarea{min-height:34px; resize:vertical}
  input:focus, select:focus, textarea:focus{border-color:rgba(233,238,248,.38); box-shadow:0 0 0 3px rgba(233,238,248,.08)}
  select{appearance:none; -webkit-appearance:none; -moz-appearance:none; padding-right:34px; cursor:pointer;}
  .selectWrap{position:relative}
  .selectWrap:after{content:"▾"; position:absolute; right:12px; top:50%; transform:translateY(-50%); pointer-events:none; color:rgba(233,238,248,.7); font-size:12px;}
  .dateRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .sep{opacity:.65; font-size:12px}
  .chips{display:flex; gap:8px; flex-wrap:wrap;}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(233,238,248,.18); background:rgba(233,238,248,.06); font-size:12px;}
  .chip .x{cursor:pointer; opacity:.85; border:1px solid rgba(233,238,248,.16); border-radius:999px; padding:0 6px;}
  .chip .x:hover{opacity:1;border-color:rgba(233,238,248,.32)}
  .kpis{display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:12px; margin-top:8px}
  .kpis b{color:var(--text); font-weight:700}
  .list{display:flex; flex-direction:column; gap:10px;}
  .row{border:1px solid var(--line); background:rgba(255,255,255,.02); border-radius:16px; padding:10px 10px; display:grid; grid-template-columns: 170px 1fr 210px 210px 130px; gap:10px; align-items:start;}
  @media (max-width: 980px){ .row{grid-template-columns: 1fr; } }
  .cell{min-width:0}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .mono{font-family:var(--mono)}
  .pill{display:inline-flex; align-items:center; justify-content:center; padding:5px 10px; border-radius:999px; border:1px solid var(--line2); background:#000; font-size:12px; cursor:pointer; user-select:none;}
  .pill:hover{border-color:rgba(233,238,248,.32)}
  .pill[data-v="已买"]{border-color:rgba(34,197,94,.55); background:rgba(34,197,94,.12)}
  .pill[data-v="抽选中"]{border-color:rgba(59,130,246,.55); background:rgba(59,130,246,.12)}
  .pill[data-v="未买"]{border-color:rgba(239,68,68,.55); background:rgba(239,68,68,.12)}
  .pill[data-v="已入金"]{border-color:rgba(234,179,8,.55); background:rgba(234,179,8,.12)}
  .pill[data-v="已出票"]{border-color:rgba(168,85,247,.55); background:rgba(168,85,247,.12)}
  .pill[data-v="已退票"]{border-color:rgba(148,163,184,.45); background:rgba(148,163,184,.08)}
  .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
  .err{display:none; margin:10px 0 0; padding:10px 12px; border-radius:14px; border:1px solid rgba(239,68,68,.45); background:rgba(239,68,68,.12); color:#ffd7d7; font-size:12px; white-space:pre-wrap}
  .toggle{cursor:pointer; color:rgba(233,238,248,.85); text-decoration:underline; text-underline-offset:3px}
  .hidden{display:none}

/* Layout scaffolding */
.container{
  max-width: 1160px;
  margin: 0 auto;
  padding: 22px 16px 40px;
}

.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:14px;
}

.brand{
  display:flex;
  align-items:center;
  gap:12px;
}
.brand .avatar{
  width:44px;height:44px;border-radius:999px;
  object-fit:cover;
  border:1px solid var(--line2);
  box-shadow: var(--shadow2);
  background:rgba(255,255,255,.06);
}
.brand .title{
  display:flex; flex-direction:column; gap:2px;
}
.brand .title b{ font-size:14px; letter-spacing:.2px; }
.brand .title span{ font-size:12px; color:var(--muted); }

.pills{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

.card{
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border:1px solid var(--line);
  border-radius: var(--r2);
  box-shadow: var(--shadow);
  overflow:hidden;
}

.cardHeader{
  padding: 14px 16px 10px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  background: rgba(255,255,255,.02);
  border-bottom:1px solid var(--line);
}
.cardHeader .h{
  display:flex; flex-direction:column; gap:2px;
}
.cardHeader .h b{ font-size:13px; }
.cardHeader .h span{ font-size:12px; color:var(--muted2); }

.cardBody{ padding: 14px 16px 16px; }

.gridAdd{
  display:grid;
  grid-template-columns: repeat(12, 1fr);
  gap:10px;
}
.gridAdd .field{ min-width:0; }
.gridAdd .span-12{ grid-column: span 12; }
.gridAdd .span-6{ grid-column: span 6; }
.gridAdd .span-4{ grid-column: span 4; }
.gridAdd .span-3{ grid-column: span 3; }
.gridAdd .span-2{ grid-column: span 2; }

@media (max-width: 920px){
  .gridAdd{ grid-template-columns: repeat(6, 1fr); }
  .gridAdd .span-6{ grid-column: span 6; }
  .gridAdd .span-4{ grid-column: span 6; }
  .gridAdd .span-3{ grid-column: span 3; }
  .gridAdd .span-2{ grid-column: span 3; }
}
@media (max-width: 520px){
  .gridAdd{ grid-template-columns: repeat(2, 1fr); }
  .gridAdd .span-3{ grid-column: span 2; }
  .gridAdd .span-2{ grid-column: span 2; }
}

/* Inputs */
.label{ font-size:11px; color:var(--muted2); margin-bottom:6px; }
input, textarea{
  width:100%;
  box-sizing:border-box;
  background: rgba(0,0,0,.55);
  border:1px solid var(--line);
  border-radius: 14px;
  color: var(--text);
  padding: 10px 12px;
  font-size: 13px;
}
input:focus, textarea:focus{
  outline:none;
  border-color: rgba(124,58,237,.55);
  box-shadow: 0 0 0 3px rgba(124,58,237,.18);
}

.btn{
  border:1px solid var(--line2);
  background: rgba(255,255,255,.06);
  color:var(--text);
  padding: 9px 12px;
  border-radius: 999px;
  font-size: 12px;
  cursor:pointer;
}
.btn:hover{ border-color: rgba(255,255,255,.28); background: rgba(255,255,255,.08); }
.btn.primary{ background: rgba(124,58,237,.22); border-color: rgba(124,58,237,.45); }
.btn.primary:hover{ background: rgba(124,58,237,.28); }
.btn.ghost{ background: transparent; }
.btn.danger{ background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.40); }
.btn.small{ padding: 7px 10px; font-size: 11px; }
.btnRow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

/* Toolbar */
.toolbar{
  position: sticky;
  top: 10px;
  z-index: 5;
  backdrop-filter: blur(10px);
  background: rgba(8,8,12,.62);
  border:1px solid var(--line);
  border-radius: var(--r2);
  box-shadow: var(--shadow2);
  padding: 12px 12px;
  margin: 14px 0 14px;
}
.toolbarGrid{
  display:grid;
  grid-template-columns: 1.4fr repeat(4, .9fr) 1fr;
  gap:10px;
  align-items:end;
}
@media (max-width: 980px){
  .toolbarGrid{ grid-template-columns: 1fr 1fr 1fr; }
}
@media (max-width: 520px){
  .toolbarGrid{ grid-template-columns: 1fr; }
}

/* List rows */
.row{
  border:1px solid var(--line);
  border-radius: var(--r2);
  padding: 12px 12px;
  background: rgba(255,255,255,.02);
}
.row + .row{ margin-top:10px; }
.rowHead{
  display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
}
.rowTitle{
  display:flex; flex-direction:column; gap:4px; min-width:0;
}
.rowTitle .main{
  font-size:13px; font-weight:600;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.rowTitle .sub{
  font-size:12px; color:var(--muted);
  display:flex; gap:10px; flex-wrap:wrap;
}
.kv{ display:inline-flex; gap:6px; align-items:center; }
.kv .k{ color:var(--muted2); font-size:11px; }
.kv .v{ font-size:12px; }

.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding: 6px 10px;
  border-radius: 999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  font-size: 11px;
}
.pill.ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
.pill.warn{ border-color: rgba(234,179,8,.35); background: rgba(234,179,8,.10); }
.pill.bad{ border-color: rgba(239,68,68,.40); background: rgba(239,68,68,.12); }
.pill.purple{ border-color: rgba(124,58,237,.45); background: rgba(124,58,237,.14); }

.muted{ color:var(--muted); }
.muted2{ color:var(--muted2); }

/* Chips */
.chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.05);
  font-size:12px;
}
.chip .x{
  opacity:.85;
  cursor:pointer;
  padding:0 6px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
}
.chip .x:hover{ opacity:1; border-color: rgba(255,255,255,.26); }


/* Ready-like polish */
:root{
  --accent:#8b5cf6;
  --accentGlow: rgba(139,92,246,.35);
  --green:#22c55e;
  --yellow:#eab308;
  --red:#ef4444;
}

body{
  background:
    radial-gradient(900px 520px at 12% -10%, rgba(139,92,246,.26), transparent 56%),
    radial-gradient(820px 520px at 88% 0%, rgba(34,197,94,.16), transparent 62%),
    linear-gradient(180deg, rgba(255,255,255,.02), transparent 20%),
    var(--bg);
}

.card{
  background:
    linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.015)),
    radial-gradient(900px 240px at 10% 0%, rgba(139,92,246,.10), transparent 70%),
    radial-gradient(900px 240px at 90% 0%, rgba(34,197,94,.08), transparent 70%);
  border:1px solid rgba(255,255,255,.11);
}

.cardHeader{
  background: rgba(255,255,255,.02);
}

.sectionTitle{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
}
.sectionTitle b{ font-size:13px; letter-spacing:.2px; }
.sectionTitle span{ font-size:12px; color:var(--muted2); }

.kpiGrid{
  display:grid;
  grid-template-columns: repeat(6, 1fr);
  gap:10px;
}
@media (max-width: 980px){ .kpiGrid{ grid-template-columns: repeat(3, 1fr);} }
@media (max-width: 520px){ .kpiGrid{ grid-template-columns: repeat(2, 1fr);} }

.kpi{
  padding:12px 12px;
  border-radius: 18px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.35);
}
.kpi .k{ font-size:11px; color:var(--muted2); }
.kpi .v{ margin-top:6px; font-size:16px; font-weight:700; letter-spacing:.2px; }
.kpi .s{ margin-top:2px; font-size:11px; color:var(--muted); }

.tabbar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.tab{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.05);
  padding:7px 10px;
  border-radius: 999px;
  font-size:12px;
  cursor:pointer;
}
.tab.active{
  border-color: rgba(139,92,246,.45);
  background: rgba(139,92,246,.18);
  box-shadow: 0 0 0 3px rgba(139,92,246,.14);
}

.divider{
  height:1px;
  background: rgba(255,255,255,.10);
  margin: 12px 0;
}

.badgeDate{
  display:inline-flex; align-items:center; gap:6px;
  padding: 5px 10px;
  border-radius: 999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.35);
  font-size:11px;
  color: rgba(255,255,255,.82);
}

.row{
  background: rgba(0,0,0,.22);
}
.row:hover{ border-color: rgba(255,255,255,.20); background: rgba(0,0,0,.26); }

.toolbar{
  border-color: rgba(255,255,255,.10);
  background: rgba(6,6,10,.62);
}

select.cycleSelect{
  background: rgba(0,0,0,.62);
  border-color: rgba(255,255,255,.14);
}

/* If KPI box renders arbitrary divs, make them look like KPI cards */
#kpiBox > div{
  padding:12px 12px;
  border-radius: 18px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.35);
}
#kpiBox > div b{ display:block; font-size:11px; color:var(--muted2); font-weight:600; }
#kpiBox > div span{ display:block; margin-top:6px; font-size:16px; font-weight:800; }
</style>
</head>
<body>
  <div class="container">
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="avatar"><img src="./avatar.jpg" alt="avatar" onerror="this.style.display='none'; this.parentElement.textContent='CN'; this.parentElement.style.display='grid'; this.parentElement.style.placeItems='center'; this.parentElement.style.fontWeight='700'"></div>
      <div class="t">
        <b>现地计划书</b>
        <span>本地保存 · JSON 导入/导出 · 紧凑行程表</span>
      </div>
    </div>
    <div class="btns">
      <button class="btn primary" id="btnExport">导出 JSON</button>
      <button class="btn" id="btnImport">导入 JSON</button>
      <button class="btn ghost" id="btnReset">重置（清空本地）</button>
    </div>
  </div>

  <div class="panel">
    <div class="hd">
      <b>添加行程</b>
      <span class="hint">日期多选 + 女声优多选 + 航司/航班号</span>
    </div>
    <div class="bd">
      <div class="formGrid">
        <div class="field" style="grid-column: span 6;">
          <div class="label">日期（年-月-日）</div>
          <div class="dateRow">
            <span class="selectWrap" style="min-width:110px"><select id="f_year"></select></span>
            <span class="sep">-</span>
            <span class="selectWrap" style="min-width:90px"><select id="f_month"></select></span>
            <span class="sep">-</span>
            <span class="selectWrap" style="min-width:90px"><select id="f_day"></select></span>
            <button class="btn" id="btnAddDate" type="button">添加日期</button>
            <button class="btn ghost" id="btnClearDates" type="button">清空</button>
          </div>
          <div class="chips" id="dateChips" style="margin-top:8px"></div>
        </div>

        <div class="field" style="grid-column: span 3;">
          <div class="label">时间（时:分）</div>
          <div class="dateRow">
            <span class="selectWrap" style="min-width:90px"><select id="f_hour"></select></span>
            <span class="sep">:</span>
            <span class="selectWrap" style="min-width:90px"><select id="f_min"></select></span>
          </div>
        </div>

        <div class="field" style="grid-column: span 3;">
          <div class="label">票务状态</div>
          <div class="dateRow">
            <span class="pill" id="f_ticketStatus" data-v="">未设置</span>
            <span class="selectWrap" style="min-width:140px"><select id="f_ticketType"></select></span>
          </div>
        </div>

        <div class="field" style="grid-column: span 3;">
          <div class="label">国家</div>
          <input id="f_country" placeholder="日本 / 中国 ..." />
        </div>
        <div class="field" style="grid-column: span 3;">
          <div class="label">城市</div>
          <input id="f_city" placeholder="东京 / 大阪 ..." />
        </div>
        <div class="field" style="grid-column: span 6;">
          <div class="label">Live 名称</div>
          <input id="f_live" placeholder="Roselia / MyGO!!!!! ..." />
        </div>
        <div class="field" style="grid-column: span 6;">
          <div class="label">场馆</div>
          <input id="f_venue" placeholder="武道馆 / Zepp ..." />
        </div>

        <div class="field" style="grid-column: span 6;">
          <div class="label">女声优（可多选）</div>
          <div class="dateRow">
            <input id="f_seiyuuInput" placeholder="输入名字后点击添加（支持逗号批量）" />
            <button class="btn" id="btnAddSeiyuu" type="button">添加</button>
          </div>
          <div class="chips" id="seiyuuChips" style="margin-top:8px"></div>
        </div>

        <div class="field" style="grid-column: span 3;">
          <div class="label">航司</div>
          <input id="f_airline" placeholder="ANA / JAL ..." />
        </div>
        <div class="field" style="grid-column: span 3;">
          <div class="label">航班号</div>
          <input id="f_flightNo" placeholder="NH123 / JL201 ..." />
        </div>

        <div class="field" style="grid-column: span 3;">
          <div class="label">门票价格（CNY）</div>
          <input id="f_ticketPrice" type="number" min="0" step="1" placeholder="0" />
        </div>
        <div class="field" style="grid-column: span 3;">
          <div class="label">交通价格（CNY）</div>
          <input id="f_transportPrice" type="number" min="0" step="1" placeholder="0" />
        </div>
        <div class="field" style="grid-column: span 3;">
          <div class="label">住宿价格（CNY）</div>
          <input id="f_lodgingPrice" type="number" min="0" step="1" placeholder="0" />
        </div>
        <div class="field" style="grid-column: span 3;">
          <div class="label">座位</div>
          <input id="f_seat" placeholder="1F 10列 ..." />
        </div>

        <div class="field" style="grid-column: span 12;">
          <div class="label">备注</div>
          <textarea id="f_notes" placeholder="住宿信息 / 交通备注 / 其他"></textarea>
        </div>

        <div class="field" style="grid-column: span 12;">
          <div class="actions">
            <button class="btn primary" id="btnAdd" type="button">添加到行程</button>
          </div>
          <div class="kpis" id="kpiAdd"></div>
          <div class="err" id="errBox"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:14px">
    <div class="hd">
      <b>筛选与排序</b>
      <span class="hint">默认：时间越靠后越靠上</span>
    </div>
    <div class="bd">
      <div class="formGrid">
        <div class="field" style="grid-column: span 4;">
          <div class="label">关键词（Live/场馆/备注/城市）</div>
          <input id="q" placeholder="搜索…" />
        </div>
        <div class="field" style="grid-column: span 2;">
          <div class="label">国家</div>
          <span class="selectWrap"><select id="flt_country"><option value="">全部</option></select></span>
        </div>
        <div class="field" style="grid-column: span 2;">
          <div class="label">城市</div>
          <span class="selectWrap"><select id="flt_city"><option value="">全部</option></select></span>
        </div>
        <div class="field" style="grid-column: span 2;">
          <div class="label">票务状态</div>
          <span class="selectWrap"><select id="flt_ticket"><option value="">全部</option></select></span>
        </div>
        <div class="field" style="grid-column: span 2;">
          <div class="label">航司</div>
          <span class="selectWrap"><select id="flt_airline"><option value="">全部</option></select></span>
        </div>
        <div class="field" style="grid-column: span 2;">
          <div class="label">排序</div>
          <span class="selectWrap">
            <select id="sort">
              <option value="date_desc">日期↓（新→旧）</option>
              <option value="date_asc">日期↑（旧→新）</option>
              <option value="cost_desc">开销↓</option>
              <option value="cost_asc">开销↑</option>
            </select>
          </span>
        </div>
        <div class="field" style="grid-column: span 2;">
          <div class="label">操作</div>
          <div class="dateRow">
            <button class="btn" id="btnResetFilters" type="button">重置筛选</button>
          </div>
        </div>
      </div>
      <div class="kpis" id="kpiMain" style="margin-top:10px"></div>
    </div>
  </div>

  <div class="panel" style="margin-top:14px">
    <div class="hd">
      <b>行程主表</b>
      <span class="hint">紧凑布局 · 点击文字直接编辑</span>
    </div>
    <div class="bd">
      <div class="list" id="list"></div>
    </div>
  </div>

  <input type="file" id="fileJson" accept="application/json" style="display:none" />
</div>

<script>
(() => {
  const LS_KEY = "genchi_plan_v4";
  const $ = (id)=>document.getElementById(id);
  const errBox = $("errBox");
  function showErr(msg){
    errBox.style.display="block";
    errBox.textContent=String(msg||"");
  }
  function clearErr(){ errBox.style.display="none"; errBox.textContent=""; }

  window.addEventListener("error", (e)=>{ showErr("JS 错误：\n"+(e?.message||e)); });
  window.addEventListener("unhandledrejection", (e)=>{ showErr("Promise 错误：\n"+(e?.reason?.message||e?.reason||e)); });

  const state = { items: [], settings: { q:"", flt_country:"", flt_city:"", flt_ticket:"", flt_airline:"", sort:"date_desc" } };

  const addDates = [];
  const formSeiyuu = [];

  const TICKET_STATUSES = ["", "未买", "抽选中", "已买", "已入金", "已出票", "已退票"];
  const TICKET_TYPES = ["", "S席", "A席", "一般席", "见切席", "全席指定"];

  function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
  function uid(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }
  function asInt(v){ const n=parseInt(String(v??"0").replace(/[^0-9-]/g,""),10); return Number.isFinite(n)?n:0; }

  // init selects (hard-coded options)
  function fillRange(sel, start, end, pad2=false){
    sel.innerHTML="";
    for(let i=start;i<=end;i++){
      const v = pad2 ? String(i).padStart(2,"0") : String(i);
      const o=document.createElement("option"); o.value=v; o.textContent=v;
      sel.appendChild(o);
    }
  }
  function initPickers(){
    fillRange($("f_year"), 2000, 2050, false);
    fillRange($("f_month"), 1, 12, false);
    fillRange($("f_day"), 1, 31, false);
    fillRange($("f_hour"), 0, 24, true);
    fillRange($("f_min"), 0, 59, true);
    // defaults
    const d=new Date();
    $("f_year").value = String(Math.min(2050, Math.max(2000, d.getFullYear())));
    $("f_month").value = String(d.getMonth()+1);
    $("f_day").value = String(d.getDate());
    $("f_hour").value = "19";
    $("f_min").value = "00";

    // ticket type
    const tt=$("f_ticketType");
    tt.innerHTML = TICKET_TYPES.map(x=>`<option value="${esc(x)}">${esc(x||"（空）")}</option>`).join("");
    // ticket status pill
    setPill($("f_ticketStatus"), "");
  }

  function getAddDateDot(){
    const y=$("f_year").value, m=$("f_month").value, d=$("f_day").value;
    return `${y}.${parseInt(m,10)}.${parseInt(d,10)}`;
  }
  function getAddTimeStr(){
    return `${$("f_hour").value}:${$("f_min").value}`;
  }

  function setPill(el, v){
    el.dataset.v = v || "";
    el.textContent = v && v.length ? v : "未设置";
  }
  function nextTicketStatus(cur){
    const i=TICKET_STATUSES.indexOf(cur);
    return TICKET_STATUSES[(i+1+TICKET_STATUSES.length)%TICKET_STATUSES.length];
  }

  function renderDateChips(){
    const box=$("dateChips");
    box.innerHTML="";
    addDates.forEach((d, idx)=>{
      const chip=document.createElement("span");
      chip.className="chip";
      chip.innerHTML = `<span class="mono">${esc(d)}</span><span class="x">×</span>`;
      chip.querySelector(".x").addEventListener("click", ()=>{
        addDates.splice(idx,1);
        renderDateChips(); renderAddKpi();
      });
      box.appendChild(chip);
    });
  }

  const CHIP_COLORS = ["#3b82f6","#a855f7","#22c55e","#f97316","#ef4444","#14b8a6","#eab308","#8b5cf6"];
  function renderSeiyuuChips(){
    const box=$("seiyuuChips");
    box.innerHTML="";
    formSeiyuu.forEach((name, idx)=>{
      const chip=document.createElement("span");
      chip.className="chip";
      const c=CHIP_COLORS[idx%CHIP_COLORS.length];
      chip.style.borderColor = c+"66";
      chip.style.background = c+"14";
      chip.innerHTML = `<span>${esc(name)}</span><span class="x">×</span>`;
      chip.querySelector(".x").addEventListener("click", ()=>{
        formSeiyuu.splice(idx,1);
        renderSeiyuuChips(); renderAddKpi();
      });
      box.appendChild(chip);
    });
  }
  function addSeiyuuName(){
    const raw=String($("f_seiyuuInput").value||"").trim();
    if(!raw) return;
    raw.split(/[,，]/).map(s=>s.trim()).filter(Boolean).forEach(n=>{
      if(!formSeiyuu.includes(n)) formSeiyuu.push(n);
    });
    $("f_seiyuuInput").value="";
    renderSeiyuuChips(); renderAddKpi();
  }

  function normalizeItem(it){
    const x = {...it};
    x.id = String(x.id||uid());
    x.date = String(x.date||"");
    x.time = String(x.time||"");
    x.country = String(x.country||"");
    x.city = String(x.city||"");
    x.live = String(x.live||"");
    x.venue = String(x.venue||"");
    x.ticketStatus = String(x.ticketStatus||"");
    x.ticketType = String(x.ticketType||"");
    x.airline = String(x.airline||"");
    x.flightNo = String(x.flightNo||x.transportMode||""); // compatibility
    x.seat = String(x.seat||"");
    x.notes = String(x.notes||"");
    x.ticketPrice = asInt(x.ticketPrice);
    x.transportPrice = asInt(x.transportPrice);
    x.lodgingPrice = asInt(x.lodgingPrice);
    x.seiyuuTags = String(x.seiyuuTags||"");
    return x;
  }

  function parseDateISO(dot){
    const m = String(dot||"").match(/(\d{4})\.(\d{1,2})\.(\d{1,2})/);
    if(!m) return "9999-99-99";
    return `${m[1]}-${String(+m[2]).padStart(2,"0")}-${String(+m[3]).padStart(2,"0")}`;
  }
  function parseDTKey(it){
    const iso = parseDateISO(it.date);
    const t = String(it.time||"00:00");
    return `${iso}T${t.padStart(5,"0")}`;
  }
  function sumCost(it){ return asInt(it.ticketPrice)+asInt(it.transportPrice)+asInt(it.lodgingPrice); }

  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify({items: state.items, settings: state.settings}));
  }
  function load(){
    const raw=localStorage.getItem(LS_KEY);
    if(!raw) return;
    try{
      const obj=JSON.parse(raw);
      const items = Array.isArray(obj.items)?obj.items: (Array.isArray(obj)?obj:[]);
      state.items = items.map(normalizeItem);
      state.settings = {...state.settings, ...(obj.settings||{})};
    }catch(e){}
  }

  function rebuildFilterOptions(){
    const uniq=(arr)=>Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b),"zh-Hans-CN"));
    const countries = uniq(state.items.map(x=>x.country));
    const cities = uniq(state.items.map(x=>x.city));
    const tickets = uniq(state.items.map(x=>x.ticketStatus));
    const airlines = uniq(state.items.map(x=>x.airline));

    const fill=(sel, arr)=>{
      const cur=sel.value;
      sel.innerHTML = `<option value="">全部</option>` + arr.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");
      sel.value = arr.includes(cur)?cur:"";
    };
    fill($("flt_country"), countries);
    fill($("flt_city"), cities);
    fill($("flt_ticket"), tickets);
    fill($("flt_airline"), airlines);
  }

  function filtered(){
    const q=String(state.settings.q||"").toLowerCase();
    let arr=state.items.slice();
    if(state.settings.flt_country) arr=arr.filter(x=>x.country===state.settings.flt_country);
    if(state.settings.flt_city) arr=arr.filter(x=>x.city===state.settings.flt_city);
    if(state.settings.flt_ticket) arr=arr.filter(x=>x.ticketStatus===state.settings.flt_ticket);
    if(state.settings.flt_airline) arr=arr.filter(x=>x.airline===state.settings.flt_airline);
    if(q){
      arr=arr.filter(x=>{
        const hay = `${x.live} ${x.venue} ${x.city} ${x.country} ${x.notes} ${x.seiyuuTags}`.toLowerCase();
        return hay.includes(q);
      });
    }
    const s=state.settings.sort||"date_desc";
    if(s==="date_desc") arr.sort((a,b)=>parseDTKey(b).localeCompare(parseDTKey(a)));
    if(s==="date_asc") arr.sort((a,b)=>parseDTKey(a).localeCompare(parseDTKey(b)));
    if(s==="cost_desc") arr.sort((a,b)=>sumCost(b)-sumCost(a));
    if(s==="cost_asc") arr.sort((a,b)=>sumCost(a)-sumCost(b));
    return arr;
  }

  function renderKPIs(){
    const arr = filtered();
    const total=arr.length;
    const totalCost = arr.reduce((s,x)=>s+sumCost(x),0);
    const tTicket = arr.reduce((s,x)=>s+asInt(x.ticketPrice),0);
    const tTrans = arr.reduce((s,x)=>s+asInt(x.transportPrice),0);
    const tLodg = arr.reduce((s,x)=>s+asInt(x.lodgingPrice),0);
    const kpi = `条目 <b>${total}</b> · 总开销 <b>${totalCost}</b> CNY · 门票 <b>${tTicket}</b> · 交通 <b>${tTrans}</b> · 住宿 <b>${tLodg}</b>`;
    $("kpiMain").innerHTML = kpi;
  }
  function renderAddKpi(){
    $("kpiAdd").innerHTML = `已选日期 <b>${addDates.length}</b> · 女声优 <b>${formSeiyuu.length}</b>`;
  }

  function updateItem(id, patch){
    const idx=state.items.findIndex(x=>x.id===id);
    if(idx<0) return;
    state.items[idx] = normalizeItem({...state.items[idx], ...patch});
    save(); rebuildFilterOptions(); renderAll(false);
  }
  function removeItem(id){
    state.items = state.items.filter(x=>x.id!==id);
    save(); rebuildFilterOptions(); renderAll(false);
  }

  function renderList(){
    const box=$("list");
    const arr=filtered();
    box.innerHTML="";
    arr.forEach(it=>{
      const row=document.createElement("div");
      row.className="row";
      const dt = `${esc(it.date)} <span class="muted mono">${esc(it.time||"")}</span>`;
      row.innerHTML = `
        <div class="cell">
          <div class="small mono">${dt}</div>
          <div class="small muted" style="margin-top:6px">国家/城市</div>
          <div class="small"><span contenteditable="true" data-k="country">${esc(it.country)}</span> <span class="muted">/</span> <span contenteditable="true" data-k="city">${esc(it.city)}</span></div>
          <div class="small muted" style="margin-top:6px">票务</div>
          <div class="dateRow" style="margin-top:4px">
            <span class="pill" data-role="ticketPill" data-v="${esc(it.ticketStatus||"")}">${esc(it.ticketStatus||"未设置")}</span>
            <span class="muted small">${esc(it.ticketType||"")}</span>
          </div>
        </div>

        <div class="cell">
          <div class="small"><b contenteditable="true" data-k="live">${esc(it.live)}</b></div>
          <div class="small muted" style="margin-top:4px">场馆</div>
          <div class="small"><span contenteditable="true" data-k="venue">${esc(it.venue)}</span></div>
          <div class="small muted" style="margin-top:6px">备注</div>
          <div class="small"><span contenteditable="true" data-k="notes">${esc(it.notes)}</span></div>
        </div>

        <div class="cell">
          <div class="small muted">航司 / 航班号</div>
          <div class="small"><span contenteditable="true" data-k="airline">${esc(it.airline)}</span> <span class="muted">/</span> <span contenteditable="true" data-k="flightNo">${esc(it.flightNo)}</span></div>
          <div class="small muted" style="margin-top:6px">座位</div>
          <div class="small"><span contenteditable="true" data-k="seat">${esc(it.seat)}</span></div>
          <div class="small muted" style="margin-top:6px">女声优</div>
          <div class="small"><span class="toggle" data-role="toggleSeiyuu">查看/编辑</span></div>
          <div class="hidden" data-role="seiyuuBox" style="margin-top:6px">
            <input data-role="seiyuuInput" placeholder="逗号分隔" value="${esc(it.seiyuuTags||"")}" />
          </div>
        </div>

        <div class="cell">
          <div class="small muted">价格（CNY）</div>
          <div class="small">门票 <span contenteditable="true" data-k="ticketPrice">${esc(it.ticketPrice)}</span></div>
          <div class="small">交通 <span contenteditable="true" data-k="transportPrice">${esc(it.transportPrice)}</span></div>
          <div class="small">住宿 <span contenteditable="true" data-k="lodgingPrice">${esc(it.lodgingPrice)}</span></div>
          <div class="small muted" style="margin-top:6px">合计 <b class="mono">${sumCost(it)}</b></div>
        </div>

        <div class="cell">
          <div class="actions">
            <button class="btn danger" data-role="del">删除</button>
          </div>
        </div>
      `;

      // bind inline edits
      row.querySelectorAll("[contenteditable=true]").forEach(sp=>{
        sp.addEventListener("blur", ()=>{
          const k=sp.getAttribute("data-k");
          const v=sp.textContent.trim();
          if(["ticketPrice","transportPrice","lodgingPrice"].includes(k)){
            updateItem(it.id, {[k]: asInt(v)});
          }else{
            updateItem(it.id, {[k]: v});
          }
        });
      });

      // ticket pill cycle
      const pill=row.querySelector('[data-role="ticketPill"]');
      pill.addEventListener("click", ()=>{
        const next=nextTicketStatus(it.ticketStatus||"");
        updateItem(it.id, {ticketStatus: next});
      });

      // seiyuu toggle
      const tgl=row.querySelector('[data-role="toggleSeiyuu"]');
      const sbox=row.querySelector('[data-role="seiyuuBox"]');
      const sin=row.querySelector('[data-role="seiyuuInput"]');
      tgl.addEventListener("click", ()=>{
        sbox.classList.toggle("hidden");
        if(!sbox.classList.contains("hidden")) sin.focus();
      });
      sin.addEventListener("change", ()=>{ updateItem(it.id, {seiyuuTags: sin.value.trim()}); });

      // delete
      row.querySelector('[data-role="del"]').addEventListener("click", ()=>{ removeItem(it.id); });

      box.appendChild(row);
    });
  }

  function renderAll(clearError){
    if(clearError) clearErr();
    rebuildFilterOptions();
    renderKPIs();
    renderAddKpi();
    renderDateChips();
    renderSeiyuuChips();
    renderList();
  }

  function addFromForm(){
    clearErr();
    if(addDates.length===0){
      showErr("请先点击【添加日期】至少加入一个日期。");
      return;
    }
    const itBase = {
      time: getAddTimeStr(),
      country: $("f_country").value.trim() || "日本",
      city: $("f_city").value.trim(),
      live: $("f_live").value.trim(),
      venue: $("f_venue").value.trim(),
      ticketStatus: $("f_ticketStatus").dataset.v || "",
      ticketType: $("f_ticketType").value || "",
      airline: $("f_airline").value.trim(),
      flightNo: $("f_flightNo").value.trim(),
      seat: $("f_seat").value.trim(),
      notes: $("f_notes").value.trim(),
      ticketPrice: asInt($("f_ticketPrice").value),
      transportPrice: asInt($("f_transportPrice").value),
      lodgingPrice: asInt($("f_lodgingPrice").value),
      seiyuuTags: formSeiyuu.join(","),
    };

    addDates.forEach(d=>{
      state.items.push(normalizeItem({id:uid(), date:d, ...itBase}));
    });
    // clear seiyuu list
    formSeiyuu.splice(0, formSeiyuu.length);
    renderSeiyuuChips();
    save();
    renderAll(true);
  }

  // JSON import/export
  function exportJson(){
    const payload = {items: state.items, settings: state.settings};
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json;charset=utf-8"});
    const a=document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "genchi_plan_export.json";
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 50);
  }
  function importJsonFile(file){
    const fr=new FileReader();
    fr.onload=()=>{
      try{
        const raw = String(fr.result||"").replace(/^\uFEFF/, "").trim();
        const parsed = JSON.parse(raw);
        const items = Array.isArray(parsed.items) ? parsed.items : (Array.isArray(parsed) ? parsed : []);
        if(!Array.isArray(items)) throw new Error("JSON 格式不正确：需要 items 数组或直接数组");
        state.items = items.map(normalizeItem);
        state.settings = {...state.settings, ...(parsed.settings||{})};
        applySettingsToUI();
        save();
        renderAll(true);
        alert("导入完成");
      }catch(e){
        showErr("JSON 解析失败：\n"+(e?.message||e));
      }
    };
    fr.readAsText(file, "utf-8");
  }
  function applySettingsToUI(){
    $("q").value = state.settings.q || "";
    $("flt_country").value = state.settings.flt_country || "";
    $("flt_city").value = state.settings.flt_city || "";
    $("flt_ticket").value = state.settings.flt_ticket || "";
    $("flt_airline").value = state.settings.flt_airline || "";
    $("sort").value = state.settings.sort || "date_desc";
  }
  function readSettingsFromUI(){
    state.settings.q = $("q").value || "";
    state.settings.flt_country = $("flt_country").value || "";
    state.settings.flt_city = $("flt_city").value || "";
    state.settings.flt_ticket = $("flt_ticket").value || "";
    state.settings.flt_airline = $("flt_airline").value || "";
    state.settings.sort = $("sort").value || "date_desc";
  }

  // wire add controls
  $("btnAddDate").addEventListener("click", ()=>{
    const d=getAddDateDot();
    if(!addDates.includes(d)) addDates.push(d);
    addDates.sort((a,b)=>parseDateISO(a).localeCompare(parseDateISO(b)));
    renderDateChips(); renderAddKpi();
  });
  $("btnClearDates").addEventListener("click", ()=>{ addDates.splice(0,addDates.length); renderDateChips(); renderAddKpi(); });
  $("btnAddSeiyuu").addEventListener("click", addSeiyuuName);
  $("f_seiyuuInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addSeiyuuName(); } });
  $("f_ticketStatus").addEventListener("click", ()=>{
    const cur=$("f_ticketStatus").dataset.v||"";
    setPill($("f_ticketStatus"), nextTicketStatus(cur));
  });
  $("btnAdd").addEventListener("click", addFromForm);

  // wire filter controls
  ["q","flt_country","flt_city","flt_ticket","flt_airline","sort"].forEach(id=>{
    $(id).addEventListener("input", ()=>{ readSettingsFromUI(); save(); renderAll(false); });
    $(id).addEventListener("change", ()=>{ readSettingsFromUI(); save(); renderAll(false); });
  });
  $("btnResetFilters").addEventListener("click", ()=>{
    state.settings = {...state.settings, q:"", flt_country:"", flt_city:"", flt_ticket:"", flt_airline:"", sort:"date_desc"};
    applySettingsToUI(); save(); renderAll(false);
  });

  // top buttons
  $("btnExport").addEventListener("click", exportJson);
  $("btnImport").addEventListener("click", ()=>$("fileJson").click());
  $("fileJson").addEventListener("change", (e)=>{ const f=e.target.files?.[0]; if(f) importJsonFile(f); e.target.value=""; });
  $("btnReset").addEventListener("click", ()=>{
    if(!confirm("确定清空本地保存并重置吗？")) return;
    localStorage.removeItem(LS_KEY);
    state.items=[]; state.settings={ q:"", flt_country:"", flt_city:"", flt_ticket:"", flt_airline:"", sort:"date_desc" };
    applySettingsToUI();
    addDates.splice(0,addDates.length);
    formSeiyuu.splice(0,formSeiyuu.length);
    initPickers();
    save();
    renderAll(true);
  });

  // bootstrap
  initPickers();
  load();
  applySettingsToUI();
  renderAll(true);
})();
</script>
  </div>
</body>
</html>

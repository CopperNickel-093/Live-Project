<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>现地计划书</title>
<style>
  :root{
    --bg:#0b0c0f;
    --panel:#0f1117;
    --panel2:#0c0e14;
    --text:#e9eef8;
    --muted:rgba(233,238,248,.65);
    --line:rgba(233,238,248,.12);
    --line2:rgba(233,238,248,.18);
    --pill:#000;
    --shadow: 0 8px 30px rgba(0,0,0,.35);
    --r:18px;
    --r2:999px;
    --gap:14px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
  }
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 20% 0%, #101424 0%, rgba(16,20,36,0) 55%), var(--bg); color:var(--text); font-family:var(--sans);}
  a{color:inherit}
  .wrap{max-width:1180px; margin:0 auto; padding:18px 14px 40px;}
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:14px; margin-bottom:14px;}
  .brand{display:flex; align-items:center; gap:12px;}
  .avatar{width:42px;height:42px;border-radius:50%; overflow:hidden; border:1px solid var(--line2); background:#111; box-shadow:var(--shadow);}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .brand .t{display:flex;flex-direction:column;line-height:1.05}
  .brand .t b{font-size:15px}
  .brand .t span{font-size:12px;color:var(--muted)}
  .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .btn{appearance:none;border:1px solid var(--line2); background:rgba(255,255,255,.04); color:var(--text); padding:8px 10px;border-radius:12px; cursor:pointer; font-size:12px;}
  .btn:hover{border-color:rgba(233,238,248,.28)}
  .btn.primary{background:rgba(59,130,246,.18); border-color:rgba(59,130,246,.45)}
  .btn.ghost{background:transparent}
  .btn.danger{background:rgba(239,68,68,.15); border-color:rgba(239,68,68,.38)}
  .grid{display:grid; gap:var(--gap);}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow);}
  .panel .hd{padding:12px 12px 0; display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .panel .hd b{font-size:13px}
  .panel .hd .hint{font-size:12px;color:var(--muted)}
  .panel .bd{padding:12px}
  .formGrid{display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:10px; align-items:end;}
  .field{display:flex; flex-direction:column; gap:6px; min-width:0;}
  .label{font-size:11px;color:var(--muted)}
  input, select, textarea{width:100%; box-sizing:border-box; background:#000; color:var(--text); border:1px solid var(--line2); border-radius:12px; padding:8px 10px; font-size:12px; outline:none;}
  textarea{min-height:34px; resize:vertical}
  input:focus, select:focus, textarea:focus{border-color:rgba(233,238,248,.38); box-shadow:0 0 0 3px rgba(233,238,248,.08)}
  select{appearance:none; -webkit-appearance:none; -moz-appearance:none; padding-right:34px; cursor:pointer;}
  .selectWrap{position:relative}
  .selectWrap:after{content:"▾"; position:absolute; right:12px; top:50%; transform:translateY(-50%); pointer-events:none; color:rgba(233,238,248,.7); font-size:12px;}
  .dateRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .sep{opacity:.65; font-size:12px}
  .chips{display:flex; gap:8px; flex-wrap:wrap;}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(233,238,248,.18); background:rgba(233,238,248,.06); font-size:12px;}
  .chip .x{cursor:pointer; opacity:.85; border:1px solid rgba(233,238,248,.16); border-radius:999px; padding:0 6px;}
  .chip .x:hover{opacity:1;border-color:rgba(233,238,248,.32)}
  .kpis{display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:12px; margin-top:8px}
  .kpis b{color:var(--text); font-weight:700}
  .list{display:flex; flex-direction:column; gap:10px;}
  .row{border:1px solid var(--line); background:rgba(255,255,255,.02); border-radius:16px; padding:10px 10px; display:grid; grid-template-columns: 190px 1.2fr 240px 200px 110px; gap:10px; align-items:start;}
  @media (max-width: 980px){ .row{grid-template-columns: 1fr; } }
  .cell{min-width:0}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .mono{font-family:var(--mono)}
  .pill{display:inline-flex; align-items:center; justify-content:center; padding:5px 10px; border-radius:999px; border:1px solid var(--line2); background:#000; font-size:12px; cursor:pointer; user-select:none;}
  .pill:hover{border-color:rgba(233,238,248,.32)}
  .pill[data-v="已买"]{border-color:rgba(34,197,94,.55); background:rgba(34,197,94,.12)}
  .pill[data-v="抽选中"]{border-color:rgba(59,130,246,.55); background:rgba(59,130,246,.12)}
  .pill[data-v="未买"]{border-color:rgba(239,68,68,.55); background:rgba(239,68,68,.12)}
  .pill[data-v="已入金"]{border-color:rgba(234,179,8,.55); background:rgba(234,179,8,.12)}
  .pill[data-v="已出票"]{border-color:rgba(168,85,247,.55); background:rgba(168,85,247,.12)}
  .pill[data-v="已退票"]{border-color:rgba(148,163,184,.45); background:rgba(148,163,184,.08)}
  .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
  .err{display:none; margin:10px 0 0; padding:10px 12px; border-radius:14px; border:1px solid rgba(239,68,68,.45); background:rgba(239,68,68,.12); color:#ffd7d7; font-size:12px; white-space:pre-wrap}
  .toggle{cursor:pointer; color:rgba(233,238,248,.85); text-decoration:underline; text-underline-offset:3px}
  .hidden{display:none}

  /* Ready-like add card polish */
  .panel.addCard{
    background:
      linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.02)),
      radial-gradient(900px 260px at 10% 0%, rgba(139,92,246,.14), transparent 70%),
      radial-gradient(900px 260px at 90% 0%, rgba(34,197,94,.10), transparent 70%);
    border-color: rgba(233,238,248,.14);
  }

  /* Stats visuals */
  .statsGrid{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:10px;
  }
  .statCard{
    border:1px solid var(--line);
    background: rgba(0,0,0,.28);
    border-radius: 16px;
    padding:12px 12px;
    min-width:0;
  }
  .statCard b{ display:block; font-size:12px; }
  .statCard .meta{ margin-top:3px; font-size:11px; color: var(--muted); }
  .canvasWrap{ height:170px; margin-top:10px; }
  .canvasWrap canvas{ width:100%; height:100%; display:block; }

  .rankGrid{
    margin-top:12px;
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:10px;
  }
  .rankCard{
    border:1px solid var(--line);
    background: rgba(0,0,0,.22);
    border-radius: 16px;
    padding:12px 12px;
    min-width:0;
  }
  .rankCard b{ display:block; font-size:12px; }
  .rankCard .meta{ margin-top:3px; font-size:11px; color: var(--muted); }
  .rankList{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }
  .rankItem{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .rankItem .name{ font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:rgba(233,238,248,.9); }
  .rankItem .val{ font-size:12px; color:rgba(233,238,248,.68); flex:0 0 auto; }
  .bar{ height:6px; border-radius:999px; background: rgba(233,238,248,.10); overflow:hidden; }
  .bar > i{ display:block; height:100%; background: rgba(139,92,246,.55); width:0%; }

  @media (max-width: 1100px){
    .statsGrid{ grid-template-columns: repeat(2, 1fr); }
    .rankGrid{ grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 680px){
    .statsGrid{ grid-template-columns: 1fr; }
    .rankGrid{ grid-template-columns: 1fr; }
  }


/* Version badge */
#verBadge{ letter-spacing:.2px; }

/* Add panel split layout (DOM-move, stable) */
.addSplit{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
}
.subCard{
  border:1px solid rgba(233,238,248,.12);
  background: rgba(0,0,0,.22);
  border-radius: 18px;
  padding:12px 12px;
  min-width:0;
}
.subHd{
  font-size:12px;
  color: rgba(233,238,248,.75);
  margin-bottom:10px;
}
.subGrid{
  display:grid;
  grid-template-columns: repeat(12, 1fr);
  gap:10px;
}
.subGrid .field{ grid-column: span 12; }
.subGrid .field.half{ grid-column: span 6; }

@media (max-width: 980px){
  .addSplit{ grid-template-columns: 1fr; }
  .subGrid .field.half{ grid-column: span 12; }
}

/* Seiyuu 2-level picker */
.seiyuuPicker{
  display:grid;
  grid-template-columns: 1fr 1.2fr auto;
  gap:10px;
  align-items:end;
  margin-top:8px;
}
.seiyuuPicker .lbl{ font-size:12px; color: rgba(233,238,248,.72); margin-bottom:6px; }
@media (max-width: 980px){
  .seiyuuPicker{ grid-template-columns: 1fr; }
}

  .liveTitle{font-size:14px; font-weight:800; letter-spacing:.2px; color:rgba(233,238,248,.95); line-height:1.25}
  .liveTitle .ph{font-weight:700; color:rgba(233,238,248,.45)}
  .kv{display:flex; flex-direction:column; gap:6px}
  .kv .line{display:flex; gap:8px; flex-wrap:wrap; align-items:baseline}
  .tag{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--line2); background:rgba(0,0,0,.45); font-size:12px; color:rgba(233,238,248,.8)}
  .tag .k{color:rgba(233,238,248,.55)}
  .sep{height:1px; background:rgba(233,238,248,.08); margin:8px 0}
  .btn.danger{border-color:rgba(239,68,68,.5)}


/* Add panel tweaks v5.4.8 */
.subCard{ padding:12px 12px; }
.subGrid{ gap:8px; }
.sectionHd{
  grid-column: span 12;
  font-size:11px;
  color: rgba(233,238,248,.6);
  letter-spacing:.4px;
  text-transform:none;
  margin-top:2px;
}
.rightBig #f_live, .rightBig #seiyuuProject, .rightBig #seiyuuMember, .rightBig #f_ticketStatus, .rightBig #f_ticketType{
  height:42px;
  font-size:13px;
}
.rightBig .field label{ font-size:12px; }
.addActionBar{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:10px;
}
.addActionBar .btn.primary{
  padding:10px 14px;
  border-radius: 999px;
}

/* v5.4.9 layout */
.addSplit{ grid-template-columns: 1fr 1fr; }
.field.third{ grid-column: span 4; }
@media (max-width: 980px){
  .field.third{ grid-column: span 12; }
}

/* v5.6 add panel layout */
.addSplit{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
@media (max-width: 720px){ .addSplit{ grid-template-columns: 1fr; } }

.rightStack .subGrid{ display:flex; flex-direction:column; gap:10px; }
.addActionBar{ display:flex; justify-content:flex-end; margin-top:10px; }

/* v5.6.1 inline date time */
.inlineRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.inlineRow select,.inlineRow input{min-width:90px}
.inlineRow .btn{height:36px}
.inlineRow .sepTxt{opacity:.55; padding:0 2px}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="avatar"><img src="./avatar.jpg" alt="avatar" onerror="this.style.display='none'; this.parentElement.textContent='CN'; this.parentElement.style.display='grid'; this.parentElement.style.placeItems='center'; this.parentElement.style.fontWeight='700'"></div>
      <div class="t">
        <b>现地计划书</b>
        <span>本地保存 · JSON 导入/导出 · 紧凑行程表</span>
      </div>
    </div>
    <div class="btns">
      <button class="btn primary" id="btnExport">导出 JSON</button>
      <button class="btn" id="btnImport">导入 JSON</button>
      <button class="btn ghost" id="btnReset">重置（清空本地）</button>
    </div>
  </div>

  <div class="panel addCard">
    <div class="hd">
      <b>添加行程</b>
      <span class="hint">日期多选 + 女声优多选 + 航司/航班号</span>
    </div>
    <div class="bd">
      <div class="formGrid">
        <div class="field" style="grid-column: span 6;">
          <div class="label">日期（年-月-日）</div>
          <div class="dateRow">
            <span class="selectWrap" style="min-width:110px"><select id="f_year"></select></span>
            <span class="sep">-</span>
            <span class="selectWrap" style="min-width:90px"><select id="f_month"></select></span>
            <span class="sep">-</span>
            <span class="selectWrap" style="min-width:90px"><select id="f_day"></select></span>
            <button class="btn" id="btnAddDate" type="button">添加日期</button>
            <button class="btn ghost" id="btnClearDates" type="button">清空</button>
          </div>
          <div class="chips" id="dateChips" style="margin-top:8px"></div>
        </div>

        <div class="field" style="grid-column: span 3;">
          <div class="label">时间（时:分）</div>
          <div class="dateRow">
            <span class="selectWrap" style="min-width:90px"><select id="f_hour"></select></span>
            <span class="sep">:</span>
            <span class="selectWrap" style="min-width:90px"><select id="f_min"></select></span>
          </div>
        </div>

        <div class="field" style="grid-column: span 3;">
          <div class="label">票务状态</div>
          <div class="dateRow">
            <span class="pill" id="f_ticketStatus" data-v="">未设置</span>
            <span class="selectWrap" style="min-width:140px"><select id="f_ticketType"></select></span>
          </div>
        </div>

        <div class="field" style="grid-column: span 3;">
          <div class="label">国家</div>
          <input id="f_country" placeholder="日本 / 中国 ..." />
        </div>
        <div class="field" style="grid-column: span 3;">
          <div class="label">城市</div>
          <input id="f_city" placeholder="东京 / 大阪 ..." />
        </div>
        <div class="field" style="grid-column: span 6;">
          <div class="label">Live 名称</div>
          <input id="f_live" placeholder="Roselia / MyGO!!!!! ..." />
        </div>
        <div class="field" style="grid-column: span 6;">
          <div class="label">场馆</div>
          <input id="f_venue" placeholder="武道馆 / Zepp ..." />
        </div>

        <div class="field" style="grid-column: span 6;">
          <div class="label">女声优（可多选）</div>
          <div class="dateRow">
            <input id="f_seiyuuInput" placeholder="输入名字后点击添加（支持逗号批量）" />
            <button class="btn" id="btnAddSeiyuu" type="button">添加</button>
          </div>
          <div class="chips" id="seiyuuChips" style="margin-top:8px"></div>
        </div>

        <div class="field" style="grid-column: span 3;">
          <div class="label">航司</div>
          <input id="f_airline" placeholder="ANA / JAL ..." />
        </div>
        <div class="field" style="grid-column: span 3;">
          <div class="label">航班号</div>
          <input id="f_flightNo" placeholder="NH123 / JL201 ..." />
        </div>

        <div class="field" style="grid-column: span 3;">
          <div class="label">门票价格（CNY）</div>
          <input id="f_ticketPrice" type="number" min="0" step="1" placeholder="0" />
        </div>
        <div class="field" style="grid-column: span 3;">
          <div class="label">交通价格（CNY）</div>
          <input id="f_transportPrice" type="number" min="0" step="1" placeholder="0" />
        </div>
        <div class="field" style="grid-column: span 3;">
          <div class="label">住宿价格（CNY）</div>
          <input id="f_lodgingPrice" type="number" min="0" step="1" placeholder="0" />
        </div>
        <div class="field" style="grid-column: span 3;">
          <div class="label">座位</div>
          <input id="f_seat" placeholder="1F 10列 ..." />
        </div>

        <div class="field" style="grid-column: span 12;">
          <div class="label">备注</div>
          <textarea id="f_notes" placeholder="住宿信息 / 交通备注 / 其他"></textarea>
        </div>

        <div class="field" style="grid-column: span 12;">
          <div class="actions">
      <span class="pill purple" id="verBadge">v5.6.1</span>

            <button class="btn primary" id="btnAdd" type="button">添加到行程</button>
          </div>
          <div class="kpis" id="kpiAdd"></div>
          <div class="err" id="errBox"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:14px">
    <div class="hd">
      <b>筛选与排序</b>
      <span class="hint">默认：时间越靠后越靠上</span>
    </div>
    <div class="bd">
      <div class="formGrid">
        <div class="field" style="grid-column: span 4;">
          <div class="label">关键词（Live/场馆/备注/城市）</div>
          <input id="q" placeholder="搜索…" />
        </div>
        <div class="field" style="grid-column: span 2;">
          <div class="label">国家</div>
          <span class="selectWrap"><select id="flt_country"><option value="">全部</option></select></span>
        </div>
        <div class="field" style="grid-column: span 2;">
          <div class="label">城市</div>
          <span class="selectWrap"><select id="flt_city"><option value="">全部</option></select></span>
        </div>
        <div class="field" style="grid-column: span 2;">
          <div class="label">票务状态</div>
          <span class="selectWrap"><select id="flt_ticket"><option value="">全部</option></select></span>
        </div>
        <div class="field" style="grid-column: span 2;">
          <div class="label">航司</div>
          <span class="selectWrap"><select id="flt_airline"><option value="">全部</option></select></span>
        </div>
        <div class="field" style="grid-column: span 2;">
          <div class="label">排序</div>
          <span class="selectWrap">
            <select id="sort">
              <option value="date_desc">日期↓（新→旧）</option>
              <option value="date_asc">日期↑（旧→新）</option>
              <option value="cost_desc">开销↓</option>
              <option value="cost_asc">开销↑</option>
            </select>
          </span>
        </div>
        <div class="field" style="grid-column: span 2;">
          <div class="label">操作</div>
          <div class="dateRow">
            <button class="btn" id="btnResetFilters" type="button">重置筛选</button>
          </div>
        </div>
      </div>
      <div class="kpis" id="kpiMain" style="margin-top:10px"></div>
    </div>
  </div>

  
  <div class="panel" id="statsPanel" style="margin-top:14px">
    <div class="hd">
      <b>统计区</b>
      <span class="hint">基于当前筛选结果 · 自动更新</span>
    </div>
    <div class="bd">
      <div class="kpis" id="kpiStats"></div>
      <div style="height:10px"></div>

      <div class="statsGrid">
        <div class="statCard">
          <b>国家分布</b><div class="meta">Top 6 + 其他</div>
          <div class="canvasWrap"><canvas id="pie_country"></canvas></div>
        </div>
        <div class="statCard">
          <b>城市分布</b><div class="meta">Top 6 + 其他</div>
          <div class="canvasWrap"><canvas id="pie_city"></canvas></div>
        </div>
        <div class="statCard">
          <b>航司分布</b><div class="meta">Top 6 + 其他</div>
          <div class="canvasWrap"><canvas id="pie_airline"></canvas></div>
        </div>
        <div class="statCard">
          <b>女声优次数</b><div class="meta">Top 6 + 其他</div>
          <div class="canvasWrap"><canvas id="pie_seiyuu"></canvas></div>
        </div>
      </div>

      <div class="rankGrid" id="statsRanks"></div>
    </div>
  </div>


<div class="panel" style="margin-top:14px">
    <div class="hd">
      <b>行程主表</b>
      <span class="hint">紧凑布局 · 点击文字直接编辑</span>
    </div>
    <div class="bd">
      <div class="list" id="list"></div>
    </div>
  </div>

  <input type="file" id="fileJson" accept="application/json" style="display:none" />
</div>

<script>
(() => {
  const APP_VERSION = "v5.6.1";
  const LS_KEY = "genchi_plan_v4";
  const $ = (id)=>document.getElementById(id);
  const errBox = $("errBox");
  function showErr(msg){
    errBox.style.display="block";
    errBox.textContent=String(msg||"");
  }
  function clearErr(){ errBox.style.display="none"; errBox.textContent=""; }

  window.addEventListener("error", (e)=>{ showErr("JS 错误：\n"+(e?.message||e)); });
  window.addEventListener("unhandledrejection", (e)=>{ showErr("Promise 错误：\n"+(e?.reason?.message||e?.reason||e)); });

  const state = { items: [], settings: { q:"", flt_country:"", flt_city:"", flt_ticket:"", flt_airline:"", sort:"date_desc" } };

  const addDates = [];
  const formSeiyuu = [];

  const TICKET_STATUSES = ["", "未买", "抽选中", "已买", "已入金", "已出票", "已退票"];
  const TICKET_TYPES = ["", "S席", "A席", "一般席", "见切席", "全席指定"];

  function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
  
const SEIYUU_GROUPS = {
  "Poppin'Party": ["愛美","大塚紗英","西本りみ","大橋彩香","伊藤彩沙"],
  "Afterglow": ["佐倉綾音","三澤紗千香","加藤英美里","日笠陽子","金元寿子"],
  "Pastel＊Palettes": ["前島亜美","小澤亜李","上坂すみれ","中上育実","秦佐和子"],
  "Roselia": ["相羽あいな","工藤晴香","中島由貴","櫻川めぐ","志崎樺音"],
  "ハロー、ハッピーワールド！": ["伊藤美来","田所あずさ","吉田有里","豊田萌絵","黒沢ともよ"],
  "Morfonica": ["進藤あまね","直田姫奈","西尾夕香","mika","Ayasa"],
  "RAISE A SUILEN": ["Raychell","小原莉子","夏芽","倉知玲鳳","紡木吏佐"],
  "MyGO!!!!!": ["羊宮妃那","立石凛","青木陽菜","小日向美香","林鼓子"],
  "Ave Mujica": ["佐々木李子","渡瀬結月","岡田夢以","米澤茜","高尾奏音"],
  "夢限大みゅーたいぷ": ["仲町あられ","宮永ののか","峰月律","藤都子","千石ユノ"]
};

function initSeiyuuPicker(){
  const input = document.getElementById("f_seiyuuInput");
  if(!input) return;
  if(document.getElementById("seiyuuProject")) return;

  const field = input.closest(".field");
  if(!field) return;

  // Add picker UI above the input row
  const wrap = document.createElement("div");
  wrap.className = "seiyuuPicker";
  wrap.innerHTML = `
    <div>
      <div class="lbl">企划</div>
      <select id="seiyuuProject">
        <option value="">（请选择企划）</option>
        ${Object.keys(SEIYUU_GROUPS).map(p=>`<option value="${esc(p)}">${esc(p)}</option>`).join("")}
      </select>
    </div>
    <div>
      <div class="lbl">女声优</div>
      <select id="seiyuuMember"><option value="">（请选择）</option></select>
    </div>
    <div>
      <div class="lbl">&nbsp;</div>
      <button class="btn" type="button" id="btnPickSeiyuu">填入</button>
    </div>
  `;

  // Insert after the label of the field
  const label = field.querySelector(".label") || field.querySelector("label");
  if(label) label.insertAdjacentElement("afterend", wrap);
  else field.insertAdjacentElement("afterbegin", wrap);

  // Keep free input, but enable autocomplete with datalist for current group
  input.setAttribute("placeholder","选择女声优或直接输入（支持逗号批量）");
  let dl = document.getElementById("seiyuuList");
  if(!dl){
    dl = document.createElement("datalist");
    dl.id = "seiyuuList";
    document.body.appendChild(dl);
  }
  input.setAttribute("list","seiyuuList");

  const selProj = wrap.querySelector("#seiyuuProject");
  const selMem = wrap.querySelector("#seiyuuMember");
  const btnFill = wrap.querySelector("#btnPickSeiyuu");

  const setMembers = (proj)=>{
    const members = SEIYUU_GROUPS[proj] || [];
    selMem.innerHTML = `<option value="">（请选择）</option>` + members.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join("");
    dl.innerHTML = members.map(n=>`<option value="${esc(n)}"></option>`).join("");
  };

  selProj.addEventListener("change", ()=> setMembers(selProj.value));
  btnFill.addEventListener("click", ()=>{
    if(selMem.value){
      input.value = selMem.value;
      input.focus();
    }
  });
}

function postUIInit(){
  try{ ensureAddSplit(); }catch(e){}
  try{ initSeiyuuPicker(); }catch(e){}
}



function uid(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }
  function asInt(v){ const n=parseInt(String(v??"0").replace(/[^0-9-]/g,""),10); return Number.isFinite(n)?n:0; }

  // init selects (hard-coded options)
  function fillRange(sel, start, end, pad2=false){
    sel.innerHTML="";
    for(let i=start;i<=end;i++){
      const v = pad2 ? String(i).padStart(2,"0") : String(i);
      const o=document.createElement("option"); o.value=v; o.textContent=v;
      sel.appendChild(o);
    }
  }
  function initPickers(){
    fillRange($("f_year"), 2000, 2050, false);
    fillRange($("f_month"), 1, 12, false);
    fillRange($("f_day"), 1, 31, false);
    fillRange($("f_hour"), 0, 24, true);
    fillRange($("f_min"), 0, 59, true);
    // defaults
    const d=new Date();
    $("f_year").value = String(Math.min(2050, Math.max(2000, d.getFullYear())));
    $("f_month").value = String(d.getMonth()+1);
    $("f_day").value = String(d.getDate());
    $("f_hour").value = "19";
    $("f_min").value = "00";

    // ticket type
    const tt=$("f_ticketType");
    tt.innerHTML = TICKET_TYPES.map(x=>`<option value="${esc(x)}">${esc(x||"（空）")}</option>`).join("");
    // ticket status pill
    setPill($("f_ticketStatus"), "");
  }

  function getAddDateDot(){
    const y=$("f_year").value, m=$("f_month").value, d=$("f_day").value;
    return `${y}.${parseInt(m,10)}.${parseInt(d,10)}`;
  }
  function getAddTimeStr(){
    return `${$("f_hour").value}:${$("f_min").value}`;
  }

  function setPill(el, v){
    el.dataset.v = v || "";
    el.textContent = v && v.length ? v : "未设置";
  }
  function nextTicketStatus(cur){
    const i=TICKET_STATUSES.indexOf(cur);
    return TICKET_STATUSES[(i+1+TICKET_STATUSES.length)%TICKET_STATUSES.length];
  }

  function renderDateChips(){
    const box=$("dateChips");
    box.innerHTML="";
    addDates.forEach((d, idx)=>{
      const chip=document.createElement("span");
      chip.className="chip";
      chip.innerHTML = `<span class="mono">${esc(d)}</span><span class="x">×</span>`;
      chip.querySelector(".x").addEventListener("click", ()=>{
        addDates.splice(idx,1);
        renderDateChips(); renderAddKpi();
      });
      box.appendChild(chip);
    });
  }

  const CHIP_COLORS = ["#3b82f6","#a855f7","#22c55e","#f97316","#ef4444","#14b8a6","#eab308","#8b5cf6"];
  function renderSeiyuuChips(){
    const box=$("seiyuuChips");
    box.innerHTML="";
    formSeiyuu.forEach((name, idx)=>{
      const chip=document.createElement("span");
      chip.className="chip";
      const c=CHIP_COLORS[idx%CHIP_COLORS.length];
      chip.style.borderColor = c+"66";
      chip.style.background = c+"14";
      chip.innerHTML = `<span>${esc(name)}</span><span class="x">×</span>`;
      chip.querySelector(".x").addEventListener("click", ()=>{
        formSeiyuu.splice(idx,1);
        renderSeiyuuChips(); renderAddKpi();
      });
      box.appendChild(chip);
    });
  }
  function addSeiyuuName(){
    const raw=String($("f_seiyuuInput").value||"").trim();
    if(!raw) return;
    raw.split(/[,，]/).map(s=>s.trim()).filter(Boolean).forEach(n=>{
      if(!formSeiyuu.includes(n)) formSeiyuu.push(n);
    });
    $("f_seiyuuInput").value="";
    renderSeiyuuChips(); renderAddKpi();
  }

  function normalizeItem(it){
    const x = {...it};
    x.id = String(x.id||uid());
    x.date = String(x.date||"");
    x.time = String(x.time||"");
    x.country = String(x.country||"");
    x.city = String(x.city||"");
    x.live = String(x.live||"");
    x.venue = String(x.venue||"");
    x.ticketStatus = String(x.ticketStatus||"");
    x.ticketType = String(x.ticketType||"");
    x.airline = String(x.airline||"");
    x.flightNo = String(x.flightNo||x.transportMode||""); // compatibility
    x.seat = String(x.seat||"");
    x.notes = String(x.notes||"");
    x.ticketPrice = asInt(x.ticketPrice);
    x.transportPrice = asInt(x.transportPrice);
    x.lodgingPrice = asInt(x.lodgingPrice);
    x.seiyuuTags = String(x.seiyuuTags||"");
    return x;
  }

  function parseDateISO(dot){
    const m = String(dot||"").match(/(\d{4})\.(\d{1,2})\.(\d{1,2})/);
    if(!m) return "9999-99-99";
    return `${m[1]}-${String(+m[2]).padStart(2,"0")}-${String(+m[3]).padStart(2,"0")}`;
  }
  function parseDTKey(it){
    const iso = parseDateISO(it.date);
    const t = String(it.time||"00:00");
    return `${iso}T${t.padStart(5,"0")}`;
  }
  function sumCost(it){ return asInt(it.ticketPrice)+asInt(it.transportPrice)+asInt(it.lodgingPrice); }

  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify({items: state.items, settings: state.settings}));
  }
  function load(){
    const raw=localStorage.getItem(LS_KEY);
    if(!raw) return;
    try{
      const obj=JSON.parse(raw);
      const items = Array.isArray(obj.items)?obj.items: (Array.isArray(obj)?obj:[]);
      state.items = items.map(normalizeItem);
      state.settings = {...state.settings, ...(obj.settings||{})};
    }catch(e){}
  }

  function rebuildFilterOptions(){
    const uniq=(arr)=>Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b),"zh-Hans-CN"));
    const countries = uniq(state.items.map(x=>x.country));
    const cities = uniq(state.items.map(x=>x.city));
    const tickets = uniq(state.items.map(x=>x.ticketStatus));
    const airlines = uniq(state.items.map(x=>x.airline));

    const fill=(sel, arr)=>{
      const cur=sel.value;
      sel.innerHTML = `<option value="">全部</option>` + arr.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");
      sel.value = arr.includes(cur)?cur:"";
    };
    fill($("flt_country"), countries);
    fill($("flt_city"), cities);
    fill($("flt_ticket"), tickets);
    fill($("flt_airline"), airlines);
  }

  function filtered(){
    const q=String(state.settings.q||"").toLowerCase();
    let arr=state.items.slice();
    if(state.settings.flt_country) arr=arr.filter(x=>x.country===state.settings.flt_country);
    if(state.settings.flt_city) arr=arr.filter(x=>x.city===state.settings.flt_city);
    if(state.settings.flt_ticket) arr=arr.filter(x=>x.ticketStatus===state.settings.flt_ticket);
    if(state.settings.flt_airline) arr=arr.filter(x=>x.airline===state.settings.flt_airline);
    if(q){
      arr=arr.filter(x=>{
        const hay = `${x.live} ${x.venue} ${x.city} ${x.country} ${x.notes} ${x.seiyuuTags}`.toLowerCase();
        return hay.includes(q);
      });
    }
    const s=state.settings.sort||"date_desc";
    if(s==="date_desc") arr.sort((a,b)=>parseDTKey(b).localeCompare(parseDTKey(a)));
    if(s==="date_asc") arr.sort((a,b)=>parseDTKey(a).localeCompare(parseDTKey(b)));
    if(s==="cost_desc") arr.sort((a,b)=>sumCost(b)-sumCost(a));
    if(s==="cost_asc") arr.sort((a,b)=>sumCost(a)-sumCost(b));
    return arr;
  }

  function renderKPIs(){
    const arr = filtered();
    const total=arr.length;
    const totalCost = arr.reduce((s,x)=>s+sumCost(x),0);
    const tTicket = arr.reduce((s,x)=>s+asInt(x.ticketPrice),0);
    const tTrans = arr.reduce((s,x)=>s+asInt(x.transportPrice),0);
    const tLodg = arr.reduce((s,x)=>s+asInt(x.lodgingPrice),0);
    const kpi = `条目 <b>${total}</b> · 总开销 <b>${totalCost}</b> CNY · 门票 <b>${tTicket}</b> · 交通 <b>${tTrans}</b> · 住宿 <b>${tLodg}</b>`;
    $("kpiMain").innerHTML = kpi;
  }
  function renderAddKpi(){
    $("kpiAdd").innerHTML = `已选日期 <b>${addDates.length}</b> · 女声优 <b>${formSeiyuu.length}</b>`;
  }

  function updateItem(id, patch){
    const idx=state.items.findIndex(x=>x.id===id);
    if(idx<0) return;
    state.items[idx] = normalizeItem({...state.items[idx], ...patch});
    save(); rebuildFilterOptions(); renderAll(false);
  
    try{ postUIInit(); }catch(e){}
}
  function removeItem(id){
    state.items = state.items.filter(x=>x.id!==id);
    save(); rebuildFilterOptions(); renderAll(false);
  
    try{ postUIInit(); }catch(e){}
}

  function renderList(){
    const box=$("list");
    const arr=filtered();
    box.innerHTML="";
    arr.forEach(it=>{
      const row=document.createElement("div");
      row.className="row";
      const dt = `${esc(it.date)} <span class="muted mono">${esc(it.time||"")}</span>`;
      row.innerHTML = `
        <div class="cell kv">
          <div class="line">
            <span class="tag"><span class="k">日期</span><span class="mono">${esc(it.date)}</span></span>
            <span class="tag"><span class="k">时间</span><span class="mono">${esc(it.time||"--:--")}</span></span>
          </div>
          <div class="line">
            <span class="tag"><span class="k">国家</span><span contenteditable="true" data-k="country">${esc(it.country)}</span></span>
            <span class="tag"><span class="k">城市</span><span contenteditable="true" data-k="city">${esc(it.city)}</span></span>
          </div>
          <div class="line">
            <span class="pill" data-role="ticketPill" data-v="${esc(it.ticketStatus||"")}">${esc(it.ticketStatus||"未设置")}</span>
            <span class="muted small">${esc(it.ticketType||"")}</span>
          </div>
        </div>

        <div class="cell kv">
          <div class="liveTitle">
            <span contenteditable="true" data-k="live">${esc(it.live||"")}</span>
            ${it.live && String(it.live).trim().length ? "" : '<span class="ph">（未填写 Live）</span>'}
          </div>
          <div class="line">
            <span class="tag"><span class="k">场馆</span><span contenteditable="true" data-k="venue">${esc(it.venue)}</span></span>
            <span class="tag"><span class="k">座位</span><span contenteditable="true" data-k="seat">${esc(it.seat)}</span></span>
          </div>
          <div class="line">
            <span class="tag"><span class="k">备注</span><span contenteditable="true" data-k="notes">${esc(it.notes)}</span></span>
          </div>
        </div>

        <div class="cell kv">
          <div class="line">
            <span class="tag"><span class="k">航司</span><span contenteditable="true" data-k="airline">${esc(it.airline)}</span></span>
            <span class="tag"><span class="k">航班</span><span contenteditable="true" data-k="flightNo">${esc(it.flightNo)}</span></span>
          </div>
          <div class="line">
            <span class="tag"><span class="k">女声优</span><span class="toggle" data-role="toggleSeiyuu">查看/编辑</span></span>
          </div>
          <div class="hidden" data-role="seiyuuBox">
            <input data-role="f_seiyuuInput" placeholder="逗号分隔" value="${esc(it.seiyuuTags||"")}" />
          </div>
        </div>

        <div class="cell kv">
          <div class="line"><span class="tag"><span class="k">门票</span><span contenteditable="true" data-k="ticketPrice">${esc(it.ticketPrice)}</span><span class="muted">CNY</span></span></div>
          <div class="line"><span class="tag"><span class="k">交通</span><span contenteditable="true" data-k="transportPrice">${esc(it.transportPrice)}</span><span class="muted">CNY</span></span></div>
          <div class="line"><span class="tag"><span class="k">住宿</span><span contenteditable="true" data-k="lodgingPrice">${esc(it.lodgingPrice)}</span><span class="muted">CNY</span></span></div>
          <div class="sep"></div>
          <div class="line"><span class="tag"><span class="k">合计</span><b class="mono">${sumCost(it)}</b><span class="muted">CNY</span></span></div>
        </div>

        <div class="cell">
          <div class="actions">
            <button class="btn danger" data-role="del">删除</button>
          </div>
        </div>
      `;

      // bind inline edits
      row.querySelectorAll("[contenteditable=true]").forEach(sp=>{
        sp.addEventListener("blur", ()=>{
          const k=sp.getAttribute("data-k");
          const v=sp.textContent.trim();
          if(["ticketPrice","transportPrice","lodgingPrice"].includes(k)){
            updateItem(it.id, {[k]: asInt(v)});
          }else{
            updateItem(it.id, {[k]: v});
          }
        });
      });

      // ticket pill cycle
      const pill=row.querySelector('[data-role="ticketPill"]');
      pill.addEventListener("click", ()=>{
        const next=nextTicketStatus(it.ticketStatus||"");
        updateItem(it.id, {ticketStatus: next});
      });

      // seiyuu toggle
      const tgl=row.querySelector('[data-role="toggleSeiyuu"]');
      const sbox=row.querySelector('[data-role="seiyuuBox"]');
      const sin=row.querySelector('[data-role="f_seiyuuInput"]');
      tgl.addEventListener("click", ()=>{
        sbox.classList.toggle("hidden");
        if(!sbox.classList.contains("hidden")) sin.focus();
      });
      sin.addEventListener("change", ()=>{ updateItem(it.id, {seiyuuTags: sin.value.trim()}); });

      // delete
      row.querySelector('[data-role="del"]').addEventListener("click", ()=>{ removeItem(it.id); });

      box.appendChild(row);
    });
  }

  function renderAll(clearError){
    if(clearError) clearErr();
    rebuildFilterOptions();
    renderKPIs();
    renderAddKpi();
    renderDateChips();
    renderSeiyuuChips();
    renderList();
    renderStats();
  }

  function addFromForm(){
    clearErr();
    if(addDates.length===0){
      showErr("请先点击【添加日期】至少加入一个日期。");
      return;
    }
    const itBase = {
      time: getAddTimeStr(),
      country: $("f_country").value.trim() || "日本",
      city: $("f_city").value.trim(),
      live: $("f_live").value.trim(),
      venue: $("f_venue").value.trim(),
      ticketStatus: $("f_ticketStatus").dataset.v || "",
      ticketType: $("f_ticketType").value || "",
      airline: $("f_airline").value.trim(),
      flightNo: $("f_flightNo").value.trim(),
      seat: $("f_seat").value.trim(),
      notes: $("f_notes").value.trim(),
      ticketPrice: asInt($("f_ticketPrice").value),
      transportPrice: asInt($("f_transportPrice").value),
      lodgingPrice: asInt($("f_lodgingPrice").value),
      seiyuuTags: formSeiyuu.join(","),
    };

    addDates.forEach(d=>{
      state.items.push(normalizeItem({id:uid(), date:d, ...itBase}));
    });
    // clear seiyuu list
    formSeiyuu.splice(0, formSeiyuu.length);
    renderSeiyuuChips();
    save();
    renderAll(true);
    // safety: ensure list refresh even if filters/options changed
    try{ renderList(); }catch(e){}
    try{ postUIInit(); }catch(e){}
  }

  // JSON import/export
  function exportJson(){
    const payload = {items: state.items, settings: state.settings};
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json;charset=utf-8"});
    const a=document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "genchi_plan_export.json";
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 50);
  }
  function importJsonFile(file){
    const fr=new FileReader();
    fr.onload=()=>{
      try{
        const raw = String(fr.result||"").replace(/^\uFEFF/, "").trim();
        const parsed = JSON.parse(raw);
        const items = Array.isArray(parsed.items) ? parsed.items : (Array.isArray(parsed) ? parsed : []);
        if(!Array.isArray(items)) throw new Error("JSON 格式不正确：需要 items 数组或直接数组");
        state.items = items.map(normalizeItem);
        state.settings = {...state.settings, ...(parsed.settings||{})};
        applySettingsToUI();
        save();
        renderAll(true);
        
    try{ postUIInit(); }catch(e){}
alert("导入完成");
      }catch(e){
        showErr("JSON 解析失败：\n"+(e?.message||e));
      }
    };
    fr.readAsText(file, "utf-8");
  }
  function applySettingsToUI(){
    $("q").value = state.settings.q || "";
    $("flt_country").value = state.settings.flt_country || "";
    $("flt_city").value = state.settings.flt_city || "";
    $("flt_ticket").value = state.settings.flt_ticket || "";
    $("flt_airline").value = state.settings.flt_airline || "";
    $("sort").value = state.settings.sort || "date_desc";
  }
  function readSettingsFromUI(){
    state.settings.q = $("q").value || "";
    state.settings.flt_country = $("flt_country").value || "";
    state.settings.flt_city = $("flt_city").value || "";
    state.settings.flt_ticket = $("flt_ticket").value || "";
    state.settings.flt_airline = $("flt_airline").value || "";
    state.settings.sort = $("sort").value || "date_desc";
  }

  // wire add controls
  $("btnAddDate").addEventListener("click", ()=>{
    const d=getAddDateDot();
    if(!addDates.includes(d)) addDates.push(d);
    addDates.sort((a,b)=>parseDateISO(a).localeCompare(parseDateISO(b)));
    renderDateChips(); renderAddKpi();
  });
  $("btnClearDates").addEventListener("click", ()=>{ addDates.splice(0,addDates.length); renderDateChips(); renderAddKpi(); });
  $("btnAddSeiyuu").addEventListener("click", addSeiyuuName);
  $("f_seiyuuInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addSeiyuuName(); } });
  $("f_ticketStatus").addEventListener("click", ()=>{
    const cur=$("f_ticketStatus").dataset.v||"";
    setPill($("f_ticketStatus"), nextTicketStatus(cur));
  });
  $("btnAdd").addEventListener("click", addFromForm);

  // wire filter controls
  ["q","flt_country","flt_city","flt_ticket","flt_airline","sort"].forEach(id=>{
    $(id).addEventListener("input", ()=>{ readSettingsFromUI(); save(); renderAll(false); 
    try{ postUIInit(); }catch(e){}
});
    $(id).addEventListener("change", ()=>{ readSettingsFromUI(); save(); renderAll(false); 
    try{ postUIInit(); }catch(e){}
});
  });
  $("btnResetFilters").addEventListener("click", ()=>{
    state.settings = {...state.settings, q:"", flt_country:"", flt_city:"", flt_ticket:"", flt_airline:"", sort:"date_desc"};
    applySettingsToUI(); save(); renderAll(false);
  
    try{ postUIInit(); }catch(e){}
});

  // top buttons
  $("btnExport").addEventListener("click", exportJson);
  $("btnImport").addEventListener("click", ()=>$("fileJson").click());
  $("fileJson").addEventListener("change", (e)=>{ const f=e.target.files?.[0]; if(f) importJsonFile(f); e.target.value=""; });
  $("btnReset").addEventListener("click", ()=>{
    if(!confirm("确定清空本地保存并重置吗？")) return;
    localStorage.removeItem(LS_KEY);
    state.items=[]; state.settings={ q:"", flt_country:"", flt_city:"", flt_ticket:"", flt_airline:"", sort:"date_desc" };
    applySettingsToUI();
    addDates.splice(0,addDates.length);
    formSeiyuu.splice(0,formSeiyuu.length);
    initPickers();
    save();
    renderAll(true);
  
    try{ postUIInit(); }catch(e){}
});

  // bootstrap
  initPickers();
  
/* ===== Stats + Donut Charts (stable module) ===== */
function aggCount(arr, getter){
  const map = new Map();
  arr.forEach(it=>{
    const k = (getter(it)||"").toString().trim();
    if(!k) return;
    map.set(k, (map.get(k)||0)+1);
  });
  return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]);
}
function topWithOther(pairs, top=6){
  const topPairs = pairs.slice(0,top);
  const rest = pairs.slice(top).reduce((a,[_k,v])=>a+v,0);
  return rest>0 ? topPairs.concat([["其他", rest]]) : topPairs;
}
function ensureCanvas(cv){
  const dpr = window.devicePixelRatio || 1;
  const rect = cv.getBoundingClientRect();
  const cssW = Math.max(220, Math.floor(rect.width||0));
  const cssH = Math.max(140, Math.floor(rect.height||0));
  const w = Math.floor(cssW*dpr);
  const h = Math.floor(cssH*dpr);
  if(cv.width!==w || cv.height!==h){ cv.width=w; cv.height=h; }
  return {ctx: cv.getContext("2d"), w, h, dpr};
}
function drawDonut(cv, pairs, title){
  if(!cv) return;
  if(!pairs || !pairs.length) pairs=[["无数据",1]];
  const {ctx,w,h,dpr}=ensureCanvas(cv);
  if(!ctx) return;
  ctx.clearRect(0,0,w,h);
  const cx=w/2, cy=h/2;
  const r=Math.min(w,h)*0.42;
  const inner=r*0.62;
  const total=pairs.reduce((a,[_k,v])=>a+v,0)||1;
  const colors=["#8b5cf6","#22c55e","#3b82f6","#f97316","#eab308","#ef4444","#14b8a6","#a855f7"];
  let a0=-Math.PI/2;
  pairs.forEach(([name,val],i)=>{
    const a1=a0 + (val/total)*Math.PI*2;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a0,a1); ctx.closePath();
    ctx.fillStyle=colors[i%colors.length]+"CC"; ctx.fill();
    a0=a1;
  });
  ctx.globalCompositeOperation="destination-out";
  ctx.beginPath(); ctx.arc(cx,cy,inner,0,Math.PI*2); ctx.fill();
  ctx.globalCompositeOperation="source-over";

  // center text
  ctx.fillStyle="rgba(233,238,248,.92)";
  ctx.font=`${Math.floor(14*dpr)}px ${getComputedStyle(document.body).fontFamily}`;
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(title||"", cx, cy-6*dpr);
  ctx.fillStyle="rgba(233,238,248,.55)";
  ctx.font=`${Math.floor(11*dpr)}px ${getComputedStyle(document.body).fontFamily}`;
  ctx.fillText(`${total} 次`, cx, cy+12*dpr);

  // legend (top 6)
  const show=pairs.slice(0,6);
  const lx=10*dpr;
  const baseY=h-10*dpr-(show.length-1)*14*dpr;
  ctx.textAlign="left"; ctx.textBaseline="alphabetic";
  ctx.font=`${Math.floor(11*dpr)}px ${getComputedStyle(document.body).fontFamily}`;
  show.forEach(([name,val],i)=>{
    const y=baseY+i*14*dpr;
    ctx.fillStyle=colors[i%colors.length]+"CC"; ctx.fillRect(lx, y-10*dpr, 10*dpr, 10*dpr);
    ctx.fillStyle="rgba(233,238,248,.72)";
    ctx.fillText(String(name).slice(0,10), lx+14*dpr, y);
    ctx.fillStyle="rgba(233,238,248,.55)";
    ctx.fillText(String(val), lx+110*dpr, y);
  });
}
function renderRankCard(title, subtitle, pairs){
  const card=document.createElement("div");
  card.className="rankCard";
  card.innerHTML = `<b>${esc(title)}</b><div class="meta">${esc(subtitle||"")}</div><div class="rankList"></div>`;
  const list=card.querySelector(".rankList");
  const max = pairs.length ? pairs[0][1] : 1;
  pairs.slice(0,8).forEach(([name,val])=>{
    const item=document.createElement("div");
    item.innerHTML = `
      <div class="rankItem">
        <div class="name" title="${esc(name)}">${esc(name)}</div>
        <div class="val">${val}</div>
      </div>
      <div class="bar"><i style="width:${Math.round(val/max*100)}%"></i></div>
    `;
    list.appendChild(item);
  });
  return card;
}
function renderStats(){
  const items = filtered();
  const kpi = $("kpiStats");
  const ranks = $("statsRanks");
  if(!kpi || !ranks) return;

  const sum = (k)=> items.reduce((a,it)=> a + (Number(it[k]||0)||0), 0);
  const ticket = sum("ticketPrice");
  const lodging = sum("lodgingPrice");
  const transport = sum("transportPrice");
  const total = ticket + lodging + transport;
  kpi.innerHTML = `
    <span class="pill"><b>${items.length}</b> 条</span>
    <span class="pill"><b>${Math.round(total).toLocaleString()}</b> CNY 总开销</span>
    <span class="pill"><b>${Math.round(ticket).toLocaleString()}</b> CNY 门票</span>
    <span class="pill"><b>${Math.round(lodging).toLocaleString()}</b> CNY 住宿</span>
    <span class="pill"><b>${Math.round(transport).toLocaleString()}</b> CNY 交通</span>
  `;

  const countryPairs = topWithOther(aggCount(items, it=>it.country), 6);
  const cityPairs = topWithOther(aggCount(items, it=>it.city), 6);
  const airlinePairs = topWithOther(aggCount(items, it=>it.airline), 6);

  // seiyuu
  const smap=new Map();
  items.forEach(it=>{
    String(it.seiyuuTags||"").split(/[,，]/).map(x=>x.trim()).filter(Boolean)
      .forEach(n=>smap.set(n,(smap.get(n)||0)+1));
  });
  const seiyuuPairs = Array.from(smap.entries()).sort((a,b)=>b[1]-a[1]);
  const seiyuuDonut = topWithOther(seiyuuPairs, 6);

  // draw after layout
  const doDraw = ()=>{
    drawDonut($("pie_country"), countryPairs, "国家");
    drawDonut($("pie_city"), cityPairs, "城市");
    drawDonut($("pie_airline"), airlinePairs, "航司");
    drawDonut($("pie_seiyuu"), seiyuuDonut, "声优");
  };
  requestAnimationFrame(doDraw);
  setTimeout(doDraw, 60);

  // ranks
  ranks.innerHTML = "";
  ranks.appendChild(renderRankCard("国家 Top", "按条目数量", countryPairs));
  ranks.appendChild(renderRankCard("城市 Top", "按条目数量", cityPairs));
  ranks.appendChild(renderRankCard("航司 Top", "仅含填写航司", airlinePairs));
  ranks.appendChild(renderRankCard("女声优 Top", "按出现次数", seiyuuPairs));
}
/* ===== End Stats Module ===== */

  
/* ===== Add Panel Layout Rebuild (stable DOM move) ===== */
function moveFieldByControlId(root, controlId, target, addHalf=false){
  const el = document.getElementById(controlId);
  if(!el) return;
  const field = el.closest(".field");
  if(!field) return;
  if(addHalf) field.classList.add("half");
  target.appendChild(field);
}




function ensureAddSplit(){
  const addPanel = [...document.querySelectorAll(".panel")].find(p=>p.querySelector(".hd b")?.textContent?.includes("添加行程"));
  if(!addPanel) return;
  const bd = addPanel.querySelector(".bd");
  if(!bd) return;
  if(bd.querySelector(".addSplit")) return;

  const byId = (id)=>document.getElementById(id);
  const fieldOf = (id)=>byId(id)?.closest(".field") || null;

  // capture original controls
  const y = byId("f_year");
  const mo = byId("f_month");
  const d = byId("f_day");
  const hh = byId("f_hour");
  const mi = byId("f_min");
  const btnAddDate = byId("btnAddDate");
  const btnClearDates = byId("btnClearDates");
  const dateChips = byId("dateChips");

  const addBtn = byId("btnAddItem") || byId("btnAdd") || [...document.querySelectorAll("button")].find(b=>/添加.*行程/.test((b.textContent||"").trim()));

  const nodes = {
    // transport
    f_airline: fieldOf("f_airline"),
    f_flightNo: fieldOf("f_flightNo"),
    f_transportPrice: fieldOf("f_transportPrice"),

    // location / lodging
    f_country: fieldOf("f_country"),
    f_city: fieldOf("f_city"),
    f_venue: fieldOf("f_venue"),
    f_lodgingPrice: fieldOf("f_lodgingPrice"),

    // ticket (keep on left per your last requirement)
    f_ticketStatus: fieldOf("f_ticketStatus"),
    f_ticketType: fieldOf("f_ticketType"),
    f_ticketPrice: fieldOf("f_ticketPrice"),
    f_seat: fieldOf("f_seat"),

    // right
    f_live: fieldOf("f_live"),
    seiyuuInput: fieldOf("f_seiyuuInput") || fieldOf("seiyuuInput"),
    btnAddSeiyuu: byId("btnAddSeiyuu"),
    seiyuuChips: byId("seiyuuChips"),
    notes: fieldOf("notes"),
  };

  // Build skeleton
  const wrap=document.createElement("div");
  wrap.className="addSplit";

  const left=document.createElement("div");
  left.className="subCard";
  left.innerHTML=`<div class="subHd">左侧 · 基础信息</div><div class="subGrid" id="addLeftGrid"></div>`;

  const right=document.createElement("div");
  right.className="subCard rightBig rightStack";
  right.innerHTML=`<div class="subHd">右侧 · Live & 备注</div><div class="subGrid" id="addRightGrid"></div>`;

  wrap.appendChild(left); wrap.appendChild(right);

  const leftGrid=left.querySelector("#addLeftGrid");
  const rightGrid=right.querySelector("#addRightGrid");

  const appendField=(grid,node,half=false)=>{
    if(!node) return;
    if(half) node.classList.add("half");
    else node.classList.remove("half");
    grid.appendChild(node);
  };
  const appendRaw=(grid,node)=>{
    if(!node) return;
    const holder=document.createElement("div");
    holder.className="field";
    holder.appendChild(node);
    grid.appendChild(holder);
  };
  const makeInlineField=(labelText, controls)=>{
    const f=document.createElement("div");
    f.className="field";
    const lab=document.createElement("div");
    lab.className="label";
    lab.textContent=labelText;
    const row=document.createElement("div");
    row.className="inlineRow";
    controls.filter(Boolean).forEach(c=>row.appendChild(c));
    f.appendChild(lab); f.appendChild(row);
    return f;
  };

  // Clear and mount
  bd.innerHTML="";
  bd.appendChild(wrap);

  // TIME block (always inline)
  leftGrid.appendChild(makeInlineField("日期（年-月-日）", [y, mo, d, btnAddDate, btnClearDates]));
  appendRaw(leftGrid, dateChips);
  leftGrid.appendChild(makeInlineField("时间（时:分）", [hh, mi]));

  // TRANSPORT (after time)
  appendField(leftGrid, nodes.f_airline, true);
  appendField(leftGrid, nodes.f_flightNo, true);
  appendField(leftGrid, nodes.f_transportPrice, true);

  // LOCATION / LODGING
  appendField(leftGrid, nodes.f_country, true);
  appendField(leftGrid, nodes.f_city, true);
  appendField(leftGrid, nodes.f_venue);
  appendField(leftGrid, nodes.f_lodgingPrice, true);

  // TICKET
  appendField(leftGrid, nodes.f_ticketStatus, true);
  appendField(leftGrid, nodes.f_ticketType, true);
  appendField(leftGrid, nodes.f_ticketPrice, true);
  appendField(leftGrid, nodes.f_seat, true);

  // RIGHT stack
  appendField(rightGrid, nodes.f_live);
  appendField(rightGrid, nodes.seiyuuInput);
  if(nodes.btnAddSeiyuu) appendRaw(rightGrid, nodes.btnAddSeiyuu);
  appendRaw(rightGrid, nodes.seiyuuChips);
  appendField(rightGrid, nodes.notes);

  // add button inside right card bottom
  if(addBtn){
    const bar=document.createElement("div");
    bar.className="addActionBar";
    bar.appendChild(addBtn);
    rightGrid.appendChild(bar);
  }

  try{ initSeiyuuPicker(); }catch(e){}
}



/* ===== End Add Panel Layout Rebuild ===== */

  load();
  applySettingsToUI();
  renderAll(true);
    try{ postUIInit(); }catch(e){}
let __rt; window.addEventListener('resize', ()=>{ clearTimeout(__rt); __rt=setTimeout(()=>{ try{ renderStats(); }catch(e){} }, 120); });
})();
</script>
</body>
</html>

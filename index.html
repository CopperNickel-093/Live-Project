<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>现地计划助手</title>
  <style>
    :root{
      --bg:#0b1020; --bg2:#070a14;
      --card: rgba(18,26,51,.92);
      --text:#e8ecff; --muted:#a9b2d6;
      --line: rgba(255,255,255,.10);
      --ok:#6ef2b6; --warn:#ffd27a; --bad:#ff8a8a; --info:#86b7ff;
      --btn1:#2b3a75; --btn2:#1e2a57;
      --shadow: 0 10px 40px rgba(0,0,0,.35);
      --r:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans CJK SC", "PingFang SC", "Hiragino Sans", "Microsoft YaHei", Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(82,109,255,.25), transparent 60%),
        radial-gradient(900px 700px at 90% 20%, rgba(110,242,182,.18), transparent 60%),
        radial-gradient(900px 700px at 30% 90%, rgba(255,210,122,.14), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 40px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin-bottom:14px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .avatar{
      width:42px;height:42px;border-radius:999px;
      background:linear-gradient(135deg, rgba(134,183,255,.35), rgba(110,242,182,.25));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 6px 20px rgba(0,0,0,.22);
      overflow:hidden; flex:0 0 auto;
      display:grid; place-items:center;
      font-weight:800;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .brand .title{display:flex;flex-direction:column;line-height:1.1}
    .brand .title b{font-size:15px;letter-spacing:.2px}
    .brand .title span{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(43,58,117,.92), rgba(30,42,87,.92));
      color:var(--text);
      padding:9px 11px;
      border-radius:12px;
      cursor:pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,.22);
      font-size:12px;
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:rgba(255,255,255,.06)}
    .btn.danger{background:linear-gradient(180deg, rgba(255,138,138,.18), rgba(255,138,138,.08))}
    .btn.ok{background:linear-gradient(180deg, rgba(110,242,182,.18), rgba(110,242,182,.08))}
    .btn.small{padding:6px 9px;border-radius:10px;font-size:12px}
    /* 页面整体改为上下结构：上方录入/统计 -> 中间图表 -> 下方主表 */
    .grid{
      display:grid; gap:12px;
      grid-template-columns: 1fr;
      align-items:start;
    }
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;
    }
    .card .hd b{font-size:13px;letter-spacing:.2px}
    .card .hd span{font-size:12px;color:var(--muted)}
    .card .bd{padding:12px}
    .form{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:8px;
    }
    .field{grid-column: span 3; display:flex; flex-direction:column; gap:5px}
    .field.w2{grid-column: span 2}
    .field.w3{grid-column: span 3}
    .field.w4{grid-column: span 4}
    .field.w6{grid-column: span 6}
    .field.w12{grid-column: span 12}
    .label{font-size:11px;color:var(--muted)}
    input, select, textarea{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 12px;
      padding: 9px 10px;
      outline:none;
      font-size:12px;
    }
    textarea{min-height:38px; resize:vertical}
    input[type="number"]{font-family:var(--mono)}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .subline{
      display:flex; gap:10px; flex-wrap:wrap;
      color:var(--muted); font-size:12px
    }
    .pill{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-size:11px;
      color:var(--muted);
    }
    .pill.ok{color:var(--ok); border-color: rgba(110,242,182,.35); background:rgba(110,242,182,.10)}
    .pill.warn{color:var(--warn); border-color: rgba(255,210,122,.35); background:rgba(255,210,122,.10)}
    .pill.bad{color:var(--bad); border-color: rgba(255,138,138,.35); background:rgba(255,138,138,.10)}
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
    }
    @media (max-width: 900px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      padding:10px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background:rgba(255,255,255,.05);
    }
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:15px;font-weight:800;margin-top:4px;font-family:var(--mono)}
    .toolbar{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      margin-bottom:10px;
    }
    .toolbar .field{min-width:160px; grid-column:auto}
    .list{
      display:flex; flex-direction:column; gap:8px;
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background:rgba(255,255,255,.04);
      padding:10px 10px;
      display:grid;
      grid-template-columns: 1.2fr 2.4fr 1.4fr 1.2fr auto;
      gap:10px;
      align-items:center;
    }
    @media (max-width: 980px){
      .item{grid-template-columns: 1fr; gap:8px}
      .item .iacts{justify-content:flex-start}
    }
    .mono{font-family:var(--mono)}
    .muted{color:var(--muted)}
    .i1 b{font-size:13px}
    .i2{display:flex;flex-direction:column;gap:3px}
    .i2 .big{font-size:13px;font-weight:700;line-height:1.2}
    .i2 .small{font-size:12px;color:var(--muted);line-height:1.2}
    .iacts{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .tagPanel{
      margin-top:8px;
      border-top:1px dashed rgba(255,255,255,.14);
      padding-top:8px;
      display:none;
    }
    .tagPanel.show{display:block}
    .charts{
      display:grid;gap:10px;
      grid-template-columns: repeat(2, 1fr);
      align-items:start;
    }
    @media (max-width: 980px){ .charts{grid-template-columns:1fr} }
    .chartCard{
      padding:10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background:rgba(255,255,255,.04);
      min-height:260px;
      height:300px;
      overflow:hidden;
      display:flex;flex-direction:column;gap:8px;
    }
    .chartCard b{font-size:12px}
    /*
      Chart.js 的 responsive + maintainAspectRatio:false 需要一个“固定高度”的父容器。
      否则在部分浏览器会出现高度反复增大的反馈循环（表现为统计区无限延伸）。
    */
    .canvasWrap{position:relative;width:100%;height:230px;flex:1 1 auto;min-height:0}
    .canvasWrap canvas{width:100% !important;height:100% !important;display:block}
    .note{font-size:12px;color:var(--muted);line-height:1.4}
    .footerTip{margin-top:12px;color:var(--muted);font-size:12px}
    .rightHint{font-size:12px;color:var(--muted)}
  
    /* Controls */
    select, option{
      background:#000;
      color:var(--text);
    }
    select{
      border:1px solid rgba(255,255,255,.14);
    }
    .pillBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      white-space:nowrap;
      user-select:none;
    }
    .pillBtn.ok{border-color: rgba(110,242,182,.45); background:rgba(110,242,182,.10)}
    .pillBtn.warn{border-color: rgba(255,210,122,.45); background:rgba(255,210,122,.10)}
    .pillBtn.bad{border-color: rgba(255,138,138,.45); background:rgba(255,138,138,.10)}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .chip button{all:unset; cursor:pointer; color:var(--muted)}
    /* Compact list */
    .item{
      padding:8px 10px;
      border-radius:12px;
      gap:8px;
      grid-template-columns: 1.1fr 2.6fr 1.6fr 1.4fr auto;
    }
    .big{font-size:14px}
    .small{font-size:12px}
    .iacts .btn.small{padding:6px 10px}

  
    /* one-click cycle select */
    select.cycleSelect{
      -webkit-appearance:none; appearance:none;
      background:#000;
      color:var(--text);
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      line-height:1;
      cursor:pointer;
      text-align:center;
      min-width:96px;
    }
    select.cycleSelect:focus{ outline:none; border-color: rgba(255,255,255,.28); }
    select.cycleSelect option{ background:#000; color:#fff; }
</style>
  <!-- Chart.js (用于圆形统计图). 如需离线使用，我也可以把库内嵌进单文件。 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="avatar" id="avatarBox" title="Author">
          <img id="avatarImg" src="./avatar.jpg" alt="avatar" onerror="this.remove(); document.getElementById('avatarBox').textContent='CN';" />
        </div>
        <div class="title">
          <b id="authorName">Copper Nickel</b>
          <span>现地计划助手 · 本地保存（localStorage）</span>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnImportJson">导入 JSON</button>
        <button class="btn" id="btnExportJson">导出 JSON</button>
        <button class="btn ghost" id="btnClear">清空本地数据</button>
      </div>
    </div>

    <div class="grid">
      <!-- 上方：添加行程 + 汇总 -->
      <div class="card">
        <div class="hd">
          <div>
            <b>添加新行程</b>
            <div class="subline">
              <span class="pill">日期格式：YYYY.M.D</span>
              <span class="pill">金额：JPY</span>
              <span class="pill">女声优 TAG 可隐藏</span>
            </div>
          </div>
          <span class="rightHint" id="saveHint">已保存</span>
        </div>
        <div class="bd">
          <div class="form" id="addForm">
            <div class="field w4">
              <div class="label">日期（可多选）</div>
              <div class="row" style="gap:8px; flex-wrap:wrap">
                <input id="f_datePick" type="date" />
                <button class="btn small" type="button" id="btnAddDate">添加日期</button>
                <button class="btn small ghost" type="button" id="btnClearDates">清空</button>
              </div>
              <div class="chips" id="dateChips" style="margin-top:8px"></div>
              <div class="hint muted" style="margin-top:6px">提示：添加后会生成多条行程（每个日期一条）。</div>
            </div>
            <div class="field w2">
              <div class="label">时间</div>
              <input id="f_time" placeholder="19:00" />
            </div>
            <div class="field w2">
              <div class="label">国家</div>
              <input id="f_country" placeholder="日本" />
            </div>
            <div class="field w2">
              <div class="label">城市 / 地区</div>
              <input id="f_city" placeholder="东京" />
            </div>
            <div class="field w4">
              <div class="label">Live 名称</div>
              <input id="f_live" placeholder="Roselia ..." />
            </div>

            <div class="field w4">
              <div class="label">场馆</div>
              <input id="f_venue" placeholder="武道馆 / Zepp ..." />
            </div>
            <div class="field w2">
              <div class="label">票务状态</div>
              <div class="row" style="gap:8px">
                <button class="pillBtn" type="button" id="f_ticketBtn" data-val="">（空）</button>
                <input type="hidden" id="f_ticketStatus" value="" />
              </div>
            </div>
            <div class="field w2">
              <div class="label">门票价格（JPY）</div>
              <input id="f_ticketPrice" type="number" min="0" step="1" placeholder="0" />
            </div>

            <div class="field w2">
              <div class="label">交通方式</div>
              <select id="f_transportMode">
                <option value="">（空）</option>
                <option>徒步</option>
                <option>电车</option>
                <option>地铁</option>
                <option>巴士</option>
                <option>新干线</option>
                <option>飞机</option>
                <option>出租车</option>
                <option>自驾</option>
                <option>其他</option>
              </select>
            </div>
            <div class="field w2">
              <div class="label">交通状态</div>
              <div class="row" style="gap:8px">
                <button class="pillBtn" type="button" id="f_transportBtn" data-val="">（空）</button>
                <input type="hidden" id="f_transportStatus" value="" />
              </div>
            </div>
            <div class="field w2">
              <div class="label">航司（可选）</div>
              <input id="f_airline" placeholder="ANA / JAL / MU..." />
            </div>
            <div class="field w2">
              <div class="label">交通票价（JPY）</div>
              <input id="f_transportPrice" type="number" min="0" step="1" placeholder="0" />
            </div>

            <div class="field w2">
              <div class="label">座位 / 区域</div>
              <input id="f_seat" placeholder="A席 / 2F ..." />
            </div>
            <div class="field w2">
              <div class="label">票种</div>
              <select id="f_ticketType">
                <option value="">（空）</option>
                <option>S席</option>
                <option>A席</option>
                <option>一般席</option>
                <option>见切席</option>
                <option>全席指定</option>
              </select>
            </div>
            <div class="field w2">
              <div class="label">住宿</div>
              <input id="f_lodging" placeholder="酒店名 / 备注" />
            </div>
            <div class="field w2">
              <div class="label">住宿价格（JPY）</div>
              <input id="f_lodgingPrice" type="number" min="0" step="1" placeholder="0" />
            </div>
            <div class="field w6">
              <div class="label">备注（自由）</div>
              <input id="f_notes" placeholder="入场注意 / 同行 / 取票方式..." />
            </div>

            <div class="field w12">
              <div class="row-actions">
                <button class="btn ok" id="btnAdd">添加到行程</button>
                <button class="btn ghost" id="btnQuickToday">填入今天</button>
                <button class="btn ghost" id="btnSample">填入示例</button>
              </div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="kpis" id="kpiBox">
            <!-- filled by JS -->
          </div>

          <div class="footerTip">提示：所有数据仅保存在本机浏览器 localStorage。换设备/清缓存会丢失，请定期导出 JSON 备份。</div>
        </div>
      </div>

      <!-- 右侧：圆形统计图 -->
      <div class="card">
        <div class="hd">
          <div>
            <b>数据分析（圆形统计）</b>
            <span>基于当前筛选结果</span>
          </div>
          <span class="rightHint" id="chartHint">Chart.js 加载中…</span>
        </div>
        <div class="bd">
          <div class="charts">
            <div class="chartCard"><b>国家分布</b><div class="canvasWrap"><canvas id="c_country"></canvas></div></div>
            <div class="chartCard"><b>城市分布</b><div class="canvasWrap"><canvas id="c_city"></canvas></div></div>
            <div class="chartCard"><b>交通方式分布</b><div class="canvasWrap"><canvas id="c_transport"></canvas></div></div>
            <div class="chartCard"><b>航司分布</b><div class="canvasWrap"><canvas id="c_airline"></canvas></div></div>
            <div class="chartCard" style="grid-column:1/-1"><b>女声优 TAG 次数</b><div class="canvasWrap"><canvas id="c_seiyuu"></canvas></div></div>
          </div>
          <div class="note" id="chartNote" style="margin-top:10px;display:none">
            未能加载 Chart.js（可能是离线或被拦截）。需要的话我可以把图表库直接内嵌到单文件里实现完全离线。
          </div>
        </div>
      </div>
    </div>

    <!-- 下方：主表（紧凑） -->
    <div class="card" style="margin-top:12px">
      <div class="hd">
        <div>
          <b>行程主表（紧凑）</b>
          <span>无横向滚动 · 点击字段可编辑</span>
        </div>
        <div class="rightHint" id="countHint"></div>
      </div>
      <div class="bd">
        <div class="toolbar" id="toolbar">
          <div class="field">
            <div class="label">关键词（Live/场馆/备注/城市）</div>
            <input id="q" placeholder="搜索…" />
          </div>
          <div class="field">
            <div class="label">国家</div>
            <select id="flt_country"><option value="">全部</option></select>
          </div>
          <div class="field">
            <div class="label">城市</div>
            <select id="flt_city"><option value="">全部</option></select>
          </div>
          <div class="field">
            <div class="label">票务状态</div>
            <select id="flt_ticket"><option value="">全部</option></select>
          </div>
          <div class="field">
            <div class="label">交通方式</div>
            <select id="flt_transport"><option value="">全部</option></select>
          </div>
          <div class="field">
            <div class="label">排序</div>
            <select id="sort">
              <option value="date_asc">日期↑</option>
              <option value="date_desc">日期↓</option>
              <option value="cost_desc">开销↓</option>
              <option value="cost_asc">开销↑</option>
            </select>
          </div>
          <div class="field">
            <div class="label">操作</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn small ghost" id="btnResetFilters">重置筛选</button>
              <button class="btn small" id="btnRecalc">刷新统计</button>
            </div>
          </div>
        </div>

        <div class="list" id="list"></div>
      </div>
    </div>
  </div>

  <input type="file" id="fileJson" accept="application/json" style="display:none" />

  <script>
  ;(() => {
    const LS_KEY = "genchi_plan_ready_v3";
    const $ = (id) => document.getElementById(id);

    const el = {
      saveHint: $("saveHint"),
      countHint: $("countHint"),
      list: $("list"),
      fileJson: $("fileJson"),
      chartHint: $("chartHint"),
      chartNote: $("chartNote"),
      kpiBox: $("kpiBox"),
      q: $("q"),
      flt_country: $("flt_country"),
      flt_city: $("flt_city"),
      flt_ticket: $("flt_ticket"),
      flt_transport: $("flt_transport"),
      sort: $("sort"),
    };

    const form = {
      datePick: $("f_datePick"),
      btnAddDate: $("btnAddDate"),
      btnClearDates: $("btnClearDates"),
      dateChips: $("dateChips"),
      time: $("f_time"),
      country: $("f_country"),
      city: $("f_city"),
      live: $("f_live"),
      venue: $("f_venue"),
      ticketBtn: $("f_ticketBtn"),
      ticketStatus: $("f_ticketStatus"),
      ticketType: $("f_ticketType"),
      ticketPrice: $("f_ticketPrice"),
      transportMode: $("f_transportMode"),
      transportBtn: $("f_transportBtn"),
      transportStatus: $("f_transportStatus"),
      airline: $("f_airline"),
      transportPrice: $("f_transportPrice"),
      seat: $("f_seat"),
      lodging: $("f_lodging"),
      lodgingPrice: $("f_lodgingPrice"),
      notes: $("f_notes"),
    };

    // Make all selects behave like one-click cycle buttons
    [form.ticketType, form.transportMode, el.flt_country, el.flt_city, el.flt_ticket, el.flt_transport, el.sort].forEach(enableSelectCycle);

    /** @type {{settings:any, items:any[]}} */
    let state = {
      settings: {
        q: "",
        flt_country: "",
        flt_city: "",
        flt_ticket: "",
        flt_transport: "",
        sort: "date_desc"
      },
      items: []
    };

    let addDates = [];


    const uid = () => "r" + Math.random().toString(16).slice(2, 9);

    
    function enableSelectCycle(sel){
      if(!sel) return;
      sel.classList.add("cycleSelect");
      // Make it behave like a cycle button: pointerdown cycles to next option and prevents dropdown.
      sel.addEventListener("pointerdown", (e)=>{
        e.preventDefault();
        const n = sel.options ? sel.options.length : 0;
        if(n<=1) return;
        sel.selectedIndex = (sel.selectedIndex + 1) % n;
        sel.dispatchEvent(new Event("change", {bubbles:true}));
        sel.blur();
      });
    }
function parseDateToISO(s){
      // accept YYYY.M.D or YYYY-MM-DD
      if(!s) return "";
      const m = String(s).trim().match(/^(\d{4})[.\-/](\d{1,2})[.\-/](\d{1,2})$/);
      if(m){
        const y = m[1];
        const mo = String(m[2]).padStart(2,"0");
        const d = String(m[3]).padStart(2,"0");
        return `${y}-${mo}-${d}`;
      }
      return "";
    }

    function dateInputToDot(v){
      // v: YYYY-MM-DD
      if(!v) return "";
      const m = String(v).trim().match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return "";
      const y = m[1];
      const mo = String(parseInt(m[2],10));
      const d = String(parseInt(m[3],10));
      return `${y}.${mo}.${d}`;
    }

    function renderDateChips(){
      const box = form.dateChips;
      if(!box) return;
      box.innerHTML = "";
      for(const d of addDates){
        const chip = document.createElement("span");
        chip.className = "chip mono";
        chip.innerHTML = `${escapeHtml(d)} <button type="button" aria-label="remove">×</button>`;
        chip.querySelector("button").addEventListener("click", () => {
          addDates = addDates.filter(x=>x!==d);
          renderDateChips();
        });
        box.appendChild(chip);
      }
    }

    function setStatusButton(btn, kind, value){
      // kind: "ticket" | "transport"
      const cls = kind==="ticket" ? pillForTicket(value)[0] : pillForTransport(value)[0];
      btn.classList.remove("ok","warn","bad");
      if(cls) btn.classList.add(cls);
      btn.textContent = value ? `${value}` : "（空）";
      btn.dataset.val = value || "";
    }

    function initAddControls(){
      // multi-date
      form.btnAddDate.addEventListener("click", () => {
        const d = dateInputToDot(form.datePick.value);
        if(!d) return;
        if(!addDates.includes(d)) addDates.push(d);
        addDates.sort((a,b)=>parseDateToISO(a).localeCompare(parseDateToISO(b)));
        renderDateChips();
      });
      form.btnClearDates.addEventListener("click", () => {
        addDates = [];
        renderDateChips();
        form.datePick.value = "";
      });

      // ticket status button (same cycle as table)
      const ticketSeq = ["", "未买", "抽选中", "已买", "已入金", "已出票", "已退票"];
      setStatusButton(form.ticketBtn, "ticket", form.ticketStatus.value);
      form.ticketBtn.addEventListener("click", () => {
        const i = Math.max(0, ticketSeq.indexOf(form.ticketStatus.value||""));
        const next = ticketSeq[(i+1)%ticketSeq.length];
        form.ticketStatus.value = next;
        setStatusButton(form.ticketBtn, "ticket", next);
      });

      // transport status button (same cycle as table)
      const trSeq = ["", "未定", "已定", "已付款", "已出票"];
      setStatusButton(form.transportBtn, "transport", form.transportStatus.value);
      form.transportBtn.addEventListener("click", () => {
        const i = Math.max(0, trSeq.indexOf(form.transportStatus.value||""));
        const next = trSeq[(i+1)%trSeq.length];
        form.transportStatus.value = next;
        setStatusButton(form.transportBtn, "transport", next);
      });
    }

    function asInt(v){
      const n = Number(v);
      return Number.isFinite(n) ? Math.max(0, Math.round(n)) : 0;
    }
    function costOf(it){
      return asInt(it.ticketPrice) + asInt(it.transportPrice) + asInt(it.lodgingPrice);
    }

    function normalizeItem(raw){
      // migrate older schema (from excel starter / v2)
      const it = {...raw};

      it.id = it.id || uid();
      it.date = (it.date ?? "").toString();
      it.dateISO = it.dateISO || parseDateToISO(it.date);
      it.time = (it.time ?? "").toString();

      // old keys: event, venue, city, transport, transportStatus, seat, ticketStatus, lodging
      it.live = (it.live ?? it.event ?? "").toString();
      it.venue = (it.venue ?? "").toString();
      it.country = (it.country ?? "").toString() || guessCountry(it.city);
      it.city = (it.city ?? "").toString();

      it.ticketStatus = (it.ticketStatus ?? "").toString();
      it.ticketType = (it.ticketType ?? "").toString();
      it.transportMode = (it.transportMode ?? it.transport ?? "").toString();
      it.transport = it.transportMode; // keep compatibility
      it.transportStatus = (it.transportStatus ?? "").toString();
      it.airline = (it.airline ?? "").toString();

      it.seat = (it.seat ?? "").toString();
      it.lodging = (it.lodging ?? "").toString();
      it.notes = (it.notes ?? "").toString();

      it.ticketPrice = asInt(it.ticketPrice ?? 0);
      it.transportPrice = asInt(it.transportPrice ?? 0);
      it.lodgingPrice = asInt(it.lodgingPrice ?? 0);

      it.seiyuuTags = (it.seiyuuTags ?? "").toString(); // comma-separated
      return it;
    }

    function guessCountry(city){
      // 极简兜底：默认日本；你也可以后续自己改
      if(!city) return "日本";
      const c = String(city);
      // Chinese cities guess China
      const cnHints = ["上海","北京","广州","深圳","杭州","南京","成都","重庆","天津","武汉","西安","苏州"];
      if(cnHints.some(x => c.includes(x))) return "中国";
      return "日本";
    }

    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        try{
          const parsed = JSON.parse(raw);
          state.settings = {...state.settings, ...(parsed.settings||{})};
          state.items = Array.isArray(parsed.items) ? parsed.items.map(normalizeItem) : [];
          applySettingsToUI();
          renderAll();
          return;
        }catch(e){}
      }
      // fallback: if starter json embedded? none. start empty.
      renderAll();
    }

    let saveTimer = 0;
    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      el.saveHint.textContent = "已保存";
      el.saveHint.style.opacity = "1";
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => { el.saveHint.style.opacity = ".6"; }, 800);
    }

    function applySettingsToUI(){
      el.q.value = state.settings.q || "";
      el.flt_country.value = state.settings.flt_country || "";
      el.flt_city.value = state.settings.flt_city || "";
      el.flt_ticket.value = state.settings.flt_ticket || "";
      el.flt_transport.value = state.settings.flt_transport || "";
      el.sort.value = state.settings.sort || "date_asc";
    }

    function setSettingsFromUI(){
      state.settings.q = el.q.value.trim();
      state.settings.flt_country = el.flt_country.value;
      state.settings.flt_city = el.flt_city.value;
      state.settings.flt_ticket = el.flt_ticket.value;
      state.settings.flt_transport = el.flt_transport.value;
      state.settings.sort = el.sort.value;
    }

    function filteredItems(){
      const q = (state.settings.q || "").toLowerCase();
      let arr = state.items.slice();

      if(state.settings.flt_country) arr = arr.filter(x => (x.country||"") === state.settings.flt_country);
      if(state.settings.flt_city) arr = arr.filter(x => (x.city||"") === state.settings.flt_city);
      if(state.settings.flt_ticket) arr = arr.filter(x => (x.ticketStatus||"") === state.settings.flt_ticket);
      if(state.settings.flt_transport) arr = arr.filter(x => (x.transportMode||"") === state.settings.flt_transport);

      if(q){
        arr = arr.filter(x => {
          const hay = `${x.live} ${x.venue} ${x.city} ${x.country} ${x.notes} ${x.lodging} ${x.seiyuuTags}`.toLowerCase();
          return hay.includes(q);
        });
      }
      // sort
      const s = state.settings.sort || "date_asc";
      const getDate = (x) => x.dateISO || "9999-99-99";
      if(s === "date_asc") arr.sort((a,b) => getDate(a).localeCompare(getDate(b)));
      if(s === "date_desc") arr.sort((a,b) => getDate(b).localeCompare(getDate(a)));
      if(s === "cost_desc") arr.sort((a,b) => costOf(b)-costOf(a));
      if(s === "cost_asc") arr.sort((a,b) => costOf(a)-costOf(b));
      return arr;
    }

    function uniq(arr){
      return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b), "zh"));
    }

    function rebuildFilterOptions(){
      const items = state.items;
      const countries = uniq(items.map(x => x.country));
      const cities = uniq(items.map(x => x.city));
      const tickets = uniq(items.map(x => x.ticketStatus));
      const transports = uniq(items.map(x => x.transportMode));

      fillSelect(el.flt_country, ["", ...countries], state.settings.flt_country);
      fillSelect(el.flt_city, ["", ...cities], state.settings.flt_city);
      fillSelect(el.flt_ticket, ["", ...tickets], state.settings.flt_ticket);
      fillSelect(el.flt_transport, ["", ...transports], state.settings.flt_transport);
    }

    function fillSelect(sel, values, current){
      const prev = sel.value;
      sel.innerHTML = "";
      for(const v of values){
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v === "" ? "全部" : v;
        sel.appendChild(opt);
      }
      sel.value = current || prev || "";
    }

    function pillForTicket(st){
      const s = (st||"").trim();
      if(["已买","已入金","已出票"].includes(s)) return ["ok", s];
      if(["抽选中"].includes(s)) return ["warn", s];
      if(["未买","已退票"].includes(s)) return ["bad", s];
      return ["", s || "（空）"];
    }
    function pillForTransport(st){
      const s = (st||"").trim();
      if(["已定","已付款","已出票"].includes(s)) return ["ok", s];
      if(["未定"].includes(s)) return ["warn", s];
      return ["", s || "（空）"];
    }

    function renderList(){
      const arr = filteredItems();
      el.countHint.textContent = `显示 ${arr.length} / 总计 ${state.items.length}`;

      el.list.innerHTML = "";
      for(const it of arr){
        const div = document.createElement("div");
        div.className = "item";

        const [tkCls, tkTxt] = pillForTicket(it.ticketStatus);
        const [trCls, trTxt] = pillForTransport(it.transportStatus);

        div.innerHTML = `
          <div class="i1">
            <b class="mono">${escapeHtml(it.date || "")}</b>
            <div class="muted mono">${escapeHtml(it.time || "")}</div>
            <div class="muted">${escapeHtml(it.country || "")} · ${escapeHtml(it.city || "")}</div>
          </div>
          <div class="i2">
            <div class="big" contenteditable="true" data-k="live">${escapeHtml(it.live || "")}</div>
            <div class="small" contenteditable="true" data-k="venue">${escapeHtml(it.venue || "")}</div>
            <div class="small">
              <span class="muted">座位：</span><span contenteditable="true" data-k="seat">${escapeHtml(it.seat||"")}</span> <span class="muted" style="margin-left:10px">票种：</span><span contenteditable="true" data-k="ticketType">${escapeHtml(it.ticketType||"")}</span>
              <span class="muted" style="margin-left:10px">住宿：</span><span contenteditable="true" data-k="lodging">${escapeHtml(it.lodging||"")}</span>
            </div>
          </div>
          <div class="i3">
            <div class="subline">
              <span class="pill ${tkCls}">票务：${escapeHtml(tkTxt)}</span>
              <span class="pill ${trCls}">交通：${escapeHtml(trTxt)}</span>
            </div>
            <div class="subline" style="margin-top:6px">
              <span class="pill">门票 ¥<span class="mono" contenteditable="true" data-k="ticketPrice">${escapeHtml(String(asInt(it.ticketPrice)))}</span></span>
              <span class="pill">住宿 ¥<span class="mono" contenteditable="true" data-k="lodgingPrice">${escapeHtml(String(asInt(it.lodgingPrice)))}</span></span>
              <span class="pill">交通 ¥<span class="mono" contenteditable="true" data-k="transportPrice">${escapeHtml(String(asInt(it.transportPrice)))}</span></span>
            </div>
          </div>
          <div class="i4">
            <div class="small muted">交通方式 / 航司</div>
            <div class="small">
              <span contenteditable="true" data-k="transportMode">${escapeHtml(it.transportMode||"")}</span>
              <span class="muted"> / </span>
              <span contenteditable="true" data-k="airline">${escapeHtml(it.airline||"")}</span>
            </div>
            <div class="small muted" style="margin-top:4px">备注</div>
            <div class="small" contenteditable="true" data-k="notes">${escapeHtml(it.notes||"")}</div>
          </div>
          <div class="iacts">
            <button class="btn small ghost" data-act="tag">女声优</button>
            <button class="btn small ghost" data-act="ticket">票务</button>
            <button class="btn small ghost" data-act="transport">交通</button>
            <button class="btn small danger" data-act="del">删除</button>
          </div>
          <div class="tagPanel" data-tagpanel="1">
            <div class="label">女声优 TAG（逗号分隔，不在主表默认显示）</div>
            <input data-k="seiyuuTags" value="${escapeAttr(it.seiyuuTags||"")}" placeholder="例：相羽あいな, 工藤晴香" />
          </div>
        `;

        // bind editing
        div.querySelectorAll("[contenteditable='true']").forEach(node => {
          node.addEventListener("blur", () => {
            const k = node.dataset.k;
            if(!k) return;
            const v = node.textContent.trim();
            updateItem(it.id, k, v);
          });
        });
        div.querySelectorAll("input[data-k]").forEach(inp => {
          inp.addEventListener("change", () => {
            updateItem(it.id, inp.dataset.k, inp.value.trim());
          });
        });

        div.querySelectorAll("button[data-act]").forEach(btn => {
          btn.addEventListener("click", () => {
            const act = btn.dataset.act;
            if(act==="del"){
              if(confirm("确定删除这条行程？")){
                state.items = state.items.filter(x=>x.id!==it.id);
                save(); renderAll();
              }
              return;
            }
            if(act==="tag"){
              const p = div.querySelector(".tagPanel");
              p.classList.toggle("show");
              return;
            }
            if(act==="ticket"){
              cycleTicket(it.id);
              return;
            }
            if(act==="transport"){
              cycleTransport(it.id);
              return;
            }
          });
        });

        el.list.appendChild(div);
      }
    }

    function cycleTicket(id){
      const seq = ["", "未买", "抽选中", "已买", "已入金", "已出票", "已退票"];
      const it = state.items.find(x=>x.id===id);
      const i = Math.max(0, seq.indexOf(it.ticketStatus||""));
      const next = seq[(i+1)%seq.length];
      updateItem(id, "ticketStatus", next);
    }
    function cycleTransport(id){
      const seq = ["", "未定", "已定", "已付款", "已出票"];
      const it = state.items.find(x=>x.id===id);
      const i = Math.max(0, seq.indexOf(it.transportStatus||""));
      const next = seq[(i+1)%seq.length];
      updateItem(id, "transportStatus", next);
    }

    function updateItem(id, key, val){
      const it = state.items.find(x=>x.id===id);
      if(!it) return;

      if(["ticketPrice","transportPrice","lodgingPrice"].includes(key)){
        it[key] = asInt(val);
      }else{
        it[key] = val;
        if(key==="date"){
          it.dateISO = parseDateToISO(val) || it.dateISO;
        }
      }
      // keep compatibility
      if(key==="transportMode") it.transport = it.transportMode;
      save();
      renderAll(true);
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function escapeAttr(s){
      return escapeHtml(s).replace(/"/g,'&quot;');
    }

    function renderKPI(){
      const arr = filteredItems();
      const cities = new Set(arr.map(x=>x.city).filter(Boolean));
      const next = arr
        .filter(x=>x.dateISO)
        .sort((a,b)=>a.dateISO.localeCompare(b.dateISO))[0];

      const ticketCost = arr.reduce((s,x)=>s+asInt(x.ticketPrice),0);
      const transportCost = arr.reduce((s,x)=>s+asInt(x.transportPrice),0);
      const lodgingCost = arr.reduce((s,x)=>s+asInt(x.lodgingPrice),0);
      const totalCost = ticketCost + transportCost + lodgingCost;

      const boughtTickets = arr.filter(x=>["已买","已入金","已出票"].includes((x.ticketStatus||"").trim())).length;
      const bookedTransport = arr.filter(x=>["已定","已付款","已出票"].includes((x.transportStatus||"").trim())).length;

      const dateISOs = arr.map(x=>x.dateISO).filter(Boolean).sort();
      const range = dateISOs.length ? `${dateISOs[0]} ~ ${dateISOs[dateISOs.length-1]}` : "—";

      const kpis = [
        ["条目数", String(arr.length)],
        ["城市数", String(cities.size)],
        ["票务已完成", `${boughtTickets} / ${arr.length}`],
        ["交通已完成", `${bookedTransport} / ${arr.length}`],
        ["总开销（JPY）", String(totalCost)],
        ["门票开销（JPY）", String(ticketCost)],
        ["住宿开销（JPY）", String(lodgingCost)],
        ["交通开销（JPY）", String(transportCost)],
      ];

      el.kpiBox.innerHTML = kpis.map(([t,v]) => `
        <div class="kpi">
          <div class="t">${escapeHtml(t)}</div>
          <div class="v">${escapeHtml(v)}</div>
        </div>
      `).join("");

      // update sub-hint
      const nextTxt = next ? `${next.date} ${next.time||""} · ${next.city||""} · ${next.live||""}` : "—";
      // keep in hint
      $("saveHint").title = `日期范围：${range}\n下一条：${nextTxt}`;
    }

    // Charts
    const charts = {};
    function ensureCharts(){
      if(!window.Chart){
        el.chartHint.textContent = "Chart.js 未加载";
        el.chartNote.style.display = "block";
        return false;
      }
      el.chartHint.textContent = "已就绪";
      return true;
    }
    function countBy(arr, keyFn){
      const m = new Map();
      for(const x of arr){
        const k = (keyFn(x) || "").toString().trim() || "（空）";
        m.set(k, (m.get(k)||0)+1);
      }
      return Array.from(m.entries()).sort((a,b)=>b[1]-a[1]).slice(0, 12);
    }
    function countSeiyuu(arr){
      const m = new Map();
      for(const x of arr){
        const raw = (x.seiyuuTags||"").toString();
        const tags = raw.split(/[,，]/).map(s=>s.trim()).filter(Boolean);
        for(const t of tags){
          m.set(t, (m.get(t)||0)+1);
        }
      }
      return Array.from(m.entries()).sort((a,b)=>b[1]-a[1]).slice(0, 16);
    }
    function upsertDoughnut(id, labels, values){
      const ctx = $(id).getContext("2d");
      if(charts[id]){
        charts[id].data.labels = labels;
        charts[id].data.datasets[0].data = values;
        charts[id].update();
        return;
      }
      charts[id] = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            data: values,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom", labels: { color: "#e8ecff", boxWidth: 10 } },
            tooltip: { enabled: true }
          }
        }
      });
    }
    function renderCharts(){
      if(!ensureCharts()) return;
      const arr = filteredItems();

      const c1 = countBy(arr, x=>x.country);
      upsertDoughnut("c_country", c1.map(x=>x[0]), c1.map(x=>x[1]));

      const c2 = countBy(arr, x=>x.city);
      upsertDoughnut("c_city", c2.map(x=>x[0]), c2.map(x=>x[1]));

      const c3 = countBy(arr, x=>x.transportMode);
      upsertDoughnut("c_transport", c3.map(x=>x[0]), c3.map(x=>x[1]));

      const c4 = countBy(arr, x=>{
        if((x.transportMode||"").includes("飞机") || (x.airline||"")) return x.airline || "（空）";
        return "非飞机";
      });
      upsertDoughnut("c_airline", c4.map(x=>x[0]), c4.map(x=>x[1]));

      const c5 = countSeiyuu(arr);
      upsertDoughnut("c_seiyuu", c5.length? c5.map(x=>x[0]) : ["（空）"], c5.length? c5.map(x=>x[1]) : [1]);
    }

    function renderAll(skipSave){
      rebuildFilterOptions();
      renderKPI();
      renderList();
      renderCharts();
      if(!skipSave) save();
    }

    // Add
    function addFromForm(){
      const dates = (addDates && addDates.length) ? addDates.slice() : [];
      // fallback: if user typed a date into picker but forgot to click "添加日期"
      if(!dates.length && form.datePick.value){
        dates.push(dateInputToDot(form.datePick.value));
      }
      if(!dates.length){
        alert("请先添加至少一个日期。");
        return;
      }

      for(const d of dates){
        const it = normalizeItem({
          id: uid(),
          date: d,
          time: form.time.value.trim(),
          country: form.country.value.trim() || "日本",
          city: form.city.value.trim(),
          live: form.live.value.trim(),
          venue: form.venue.value.trim(),
          ticketStatus: form.ticketStatus.value,
          ticketType: form.ticketType.value,
          ticketPrice: form.ticketPrice.value,
          transportMode: form.transportMode.value,
          transportStatus: form.transportStatus.value,
          airline: form.airline.value.trim(),
          transportPrice: form.transportPrice.value,
          seat: form.seat.value.trim(),
          lodging: form.lodging.value.trim(),
          lodgingPrice: form.lodgingPrice.value,
          notes: form.notes.value.trim(),
          seiyuuTags: ""
        });

        state.items.unshift(it);
      }

      save();
      // keep other fields, but clear multi-date selection
      addDates = [];
      renderDateChips();
      form.datePick.value = "";
      renderAll();
      flashSaved();
    }

    // Import/Export
    function exportJson(){
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "genchi_plan_export.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function importJsonFile(file){
      const fr = new FileReader();
      fr.onload = () => {
        try{
          const parsed = JSON.parse(String(fr.result || "{}"));
          const items = Array.isArray(parsed.items) ? parsed.items : (Array.isArray(parsed) ? parsed : []);
          state.items = items.map(normalizeItem);
          state.settings = {...state.settings, ...(parsed.settings||{})};
          applySettingsToUI();
          save(); renderAll(true);
          alert("导入完成");
        }catch(e){
          alert("JSON 解析失败");
        }
      };
      fr.readAsText(file, "utf-8");
    }

    // Wire UI
    $("btnAdd").addEventListener("click", (e) => { e.preventDefault(); addFromForm(); });
    $("btnQuickToday").addEventListener("click", (e) => {
      e.preventDefault();
      const d = new Date();
      const y = d.getFullYear();
      const m = d.getMonth()+1;
      const dd = d.getDate();
      const dot = `${y}.${m}.${dd}`;
      addDates = [dot];
      renderDateChips();
      form.datePick.value = `${y}-${String(m).padStart(2,"0")}-${String(dd).padStart(2,"0")}`;
    });
    $("btnSample").addEventListener("click", (e) => {
      e.preventDefault();
      addDates = ["2026.3.1","2026.3.2"];
      renderDateChips();
      form.datePick.value = "2026-03-02";
      form.time.value = "18:30";
      form.country.value = "日本";
      form.city.value = "东京";
      form.live.value = "MyGO!!!!! LIVE";
      form.venue.value = "TOKYO DOME CITY HALL";
      form.ticketStatus.value = "抽选中";
      form.ticketPrice.value = "9800";
      form.transportMode.value = "电车";
      form.transportStatus.value = "已定";
      form.airline.value = "";
      form.transportPrice.value = "1200";
      form.lodging.value = "附近酒店";
      form.lodgingPrice.value = "15000";
      form.notes.value = "注意开演前取票";
    });

    // filters
    [el.q, el.flt_country, el.flt_city, el.flt_ticket, el.flt_transport, el.sort].forEach(node => {
      node.addEventListener("input", () => {
        setSettingsFromUI();
        save();
        renderAll(true);
      });
      node.addEventListener("change", () => {
        setSettingsFromUI();
        save();
        renderAll(true);
      });
    });

    $("btnResetFilters").addEventListener("click", () => {
      state.settings.q = "";
      state.settings.flt_country = "";
      state.settings.flt_city = "";
      state.settings.flt_ticket = "";
      state.settings.flt_transport = "";
      state.settings.sort = "date_asc";
      applySettingsToUI();
      save(); renderAll(true);
    });

    $("btnRecalc").addEventListener("click", () => renderAll(true));

    $("btnExportJson").addEventListener("click", exportJson);
    $("btnImportJson").addEventListener("click", () => el.fileJson.click());
    el.fileJson.addEventListener("change", () => {
      const f = el.fileJson.files && el.fileJson.files[0];
      if(f) importJsonFile(f);
      el.fileJson.value = "";
    });

    $("btnClear").addEventListener("click", () => {
      if(confirm("确定清空本地数据？（无法恢复）")){
        state.items = [];
        save(); renderAll(true);
      }
    });

    // init add-controls
    initAddControls();

    // Load starter if no state but starter file exists? (optional) - not auto, user can import json.
    load();
  })();
  </script>
</body>
</html>

<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>现地计划助手</title>
  <style>
    :root{
      --bg:#0b1020; --bg2:#070a14;
      --card: rgba(18,26,51,.92);
      --text:#e8ecff; --muted:#a9b2d6;
      --line: rgba(255,255,255,.10);
      --ok:#6ef2b6; --warn:#ffd27a; --bad:#ff8a8a;
      --btn1:#2b3a75; --btn2:#1e2a55;
      --shadow: 0 10px 30px rgba(0,0,0,.28);
      --radius: 16px;

      --red:#ff3b3b;
      --green:#1fd074;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background: linear-gradient(180deg,var(--bg),var(--bg2));
      color:var(--text);
    }
    .container{ max-width: 1080px; margin:0 auto; padding: 14px; }
    .topbar{
      position: sticky; top:0; z-index:50;
      background: rgba(11,16,32,.78);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding: 12px 14px;
      max-width: 1080px; margin: 0 auto;
      flex-wrap: wrap;
    }
    .author{ display:flex; align-items:center; gap:10px; min-width: 220px; }
    .avatar{
      width: 34px; height: 34px; border-radius: 50%;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
      flex: 0 0 auto;
    }
    .avatar img{ width:100%; height:100%; object-fit: cover; display:none; }
    .avatar .fallback{
      font-weight: 900; font-size: 12px;
      color: rgba(233,236,255,.85);
      letter-spacing: .3px;
      user-select:none;
    }
    .author-meta{ display:flex; flex-direction:column; gap:2px; }
    .author-meta .name{ font-weight: 900; font-size: 13px; }
    .author-meta .tag{ color: var(--muted); font-size: 12px; }

    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand .title{ font-weight: 900; letter-spacing:.2px; font-size: 16px; }
    .brand .subtitle{ color: var(--muted); font-size: 12px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btn{
      border: 1px solid var(--line);
      background: linear-gradient(180deg,var(--btn1),var(--btn2));
      color: var(--text);
      padding: 9px 11px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 700;
      font-size: 13px;
      box-shadow: 0 8px 20px rgba(0,0,0,.20);
      user-select:none;
    }
    .btn.ghost{ background: rgba(255,255,255,.05); box-shadow:none; }
    .btn.danger{ background: rgba(255,80,80,.14); }
    .btn:active{ transform: translateY(1px); }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      margin-top: 14px;
    }
    .card h3{ margin:0 0 8px 0; font-size: 14px; letter-spacing:.2px; }
    .hint{ color: var(--muted); font-size: 12px; line-height: 1.55; }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .field{ grid-column: span 6; display:flex; flex-direction:column; gap:6px; }
    .field.small{ grid-column: span 4; }
    .field.tiny{ grid-column: span 3; }
    .label{ font-size: 12px; color: var(--muted); }
    .input{
      width:100%;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 10px;
      border-radius: 12px;
      outline: none;
      font-size: 14px;
    }
    .input::placeholder{ color: rgba(233,236,255,.35); }
    .input[disabled]{ opacity: .72; }

    .hr{ height:1px; background: var(--line); margin: 12px 0; }

    .kpi-grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .kpi{
      grid-column: span 4;
      background: rgba(255,255,255,.05);
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
    }
    .kpi .k{ color: var(--muted); font-size: 12px; }
    .kpi .v{ font-weight: 900; font-size: 18px; margin-top: 4px; }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size: 12px; padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      margin-left: 8px;
    }

    .table-wrap{
      overflow:auto;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    table{ border-collapse: collapse; width:100%; font-size: 13px; min-width: 1160px; }
    th,td{
      border: 1px solid rgba(255,255,255,.08);
      padding: 8px 10px;
      white-space: nowrap;
      vertical-align: middle;
    }
    th{
      position: sticky; top:0;
      background: rgba(18,26,51,.98);
      z-index: 2;
      text-align:left;
      font-size: 12px;
      color: var(--muted);
    }
    td[contenteditable="true"]{ background: rgba(255,255,255,.04); cursor: text; }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 10px; border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: var(--muted);
    }
    .min-ok{ color: var(--ok); font-weight: 900; }
    .min-warn{ color: var(--warn); font-weight: 900; }
    .min-bad{ color: var(--bad); font-weight: 900; }

    .toggle{
      display:flex;
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      background: rgba(255,255,255,.04);
    }
    .toggle button{
      flex:1;
      padding:10px 10px;
      font-weight:900;
      font-size:13px;
      color: rgba(255,255,255,.80);
      background: transparent;
      border:0;
      cursor:pointer;
    }
    .toggle.small button{
      padding:6px 10px;
      font-size:12px;
    }
    .toggle button[data-v="NO"].active{ background: var(--red); color: #fff; }
    .toggle button[data-v="YES"].active{ background: var(--green); color: #fff; }
    .toggle button:not(.active){
      color: rgba(233,236,255,.55);
      background: rgba(255,255,255,.03);
    }

    @media (max-width: 720px){
      .field{ grid-column: span 12; }
      .field.small, .field.tiny{ grid-column: span 12; }
      .kpi{ grid-column: span 12; }
      table{ min-width: 1160px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="author">
        <div class="avatar" id="avatarBox" title="Copper Nickel">
          <img id="avatarImg" alt="Copper Nickel" />
          <div class="fallback" id="avatarFallback">CN</div>
        </div>
        <div class="author-meta">
          <div class="name" id="authorName">Copper Nickel</div>
          <div class="tag">Author</div>
        </div>
      </div>

      <div class="brand">
        <div class="title">现地计划助手 <span class="badge" id="byline">By 白铜</span></div>
        <div class="subtitle">数据仅保存在本机浏览器（localStorage），不上传服务器</div>
      </div>

      <div class="row">
        <button class="btn ghost" id="btnExport">导出JSON</button>
        <button class="btn ghost" id="btnImport">导入JSON</button>
        <button class="btn ghost" id="btnImportExcel">从 Excel 导入</button>
        <input id="excelFile" type="file" accept=".xlsx,.xls" style="display:none;" />
        <button class="btn danger" id="btnReset">重置</button>
      </div>
    </div>
  </div>

  <div class="container">

    <div class="card">
      <h3>筛选 / 计算区</h3>

      <div class="grid">
        <div class="field small">
          <div class="label">年份</div>
          <select class="input" id="yearFilter">
            <option value="ALL">全部</option>
          </select>
        </div>

        <div class="field small">
          <div class="label">城市（包含）</div>
          <input class="input" id="cityFilter" placeholder="例如 东京 / 上海" />
        </div>

        <div class="field small">
          <div class="label">票务状态</div>
          <select class="input" id="statusFilter">
            <option value="ALL">全部</option>
            <option value="BOUGHT">仅已买</option>
            <option value="NEED">仅未买/空</option>
          </select>
        </div>

        <div class="field">
          <div class="label">搜索（活动/场地/交通/座位/备注）</div>
          <input class="input" id="q" placeholder="关键词…" />
        </div>
      </div>

      <div class="kpi-grid" id="kpis"></div>

      <div class="hint" style="margin-top:10px;">
        计算口径：<b>“已买”</b>判断优先看「票务状态」包含“已买/已购/购票/購入/確保/paid”，其次可自行编辑为 YES。交通同理（已买/已订/已定/予約/済）。
      </div>
    </div>

    <div class="card">
      <h3>添加行程</h3>
      <div class="grid">
        <div class="field small">
          <div class="label">日期（YYYY.M.D）</div>
          <input class="input" id="date" placeholder="例如 2025.7.26" />
        </div>

        <div class="field">
          <div class="label">活动</div>
          <input class="input" id="event" placeholder="例如 LIVE / 展会…" />
        </div>

        <div class="field tiny">
          <div class="label">城市</div>
          <input class="input" id="city" placeholder="东京" />
        </div>

        <div class="field">
          <div class="label">场地</div>
          <input class="input" id="venue" placeholder="例如 有明アリーナ" />
        </div>

        <div class="field small">
          <div class="label">交通</div>
          <input class="input" id="transport" placeholder="例如 CA95X / T109" />
        </div>

        <div class="field tiny">
          <div class="label">交通状态</div>
          <input class="input" id="transportStatus" placeholder="已买/待定…" />
        </div>

        <div class="field small">
          <div class="label">座位</div>
          <input class="input" id="seat" placeholder="例如 S席 / L7一般席" />
        </div>

        <div class="field tiny">
          <div class="label">票务状态</div>
          <input class="input" id="ticketStatus" placeholder="已买/抽选中…" />
        </div>

        <div class="field">
          <div class="label">住宿 / 备注</div>
          <input class="input" id="lodging" placeholder="例如 全季 / 备注…" />
        </div>

        <div class="field tiny">
          <div class="label">置顶</div>
          <div class="toggle" id="pinToggle">
            <button type="button" data-v="NO" class="active">NO</button>
            <button type="button" data-v="YES">YES</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn" id="btnAdd">添加</button>
        <button class="btn ghost" id="btnAddToday">日期=今天</button>
      </div>

      <div class="hint" style="margin-top:10px;">
        说明：置顶=YES 的行会在列表最前；其他行默认按日期升序。
      </div>
    </div>

    <div class="card">
      <h3>行程清单 <span class="badge">点击单元格可编辑（自动保存）</span></h3>

      <div class="table-wrap">
        <table>
          <thead>
          <tr>
            <th>#</th>
            <th>日期</th>
            <th>活动</th>
            <th>城市</th>
            <th>场地</th>
            <th>交通</th>
            <th>交通状态</th>
            <th>座位</th>
            <th>票务状态</th>
            <th>住宿/备注</th>
            <th>置顶</th>
            <th>操作</th>
          </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="hint" style="margin-top:12px;">
        小技巧：在「票务状态/交通状态」里直接写“已买”会被计算区识别。你也可以统一用 YES/NO（大小写都行）。
      </div>
    </div>

  </div>

  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const KEY = "genchi_plan_state_v1";

    const defaultState = () => ({
      settings: {
        yearFilter: "ALL",
        cityFilter: "",
        statusFilter: "ALL",
        q: ""
      },
      items: []
    });

    function loadState(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return defaultState();
        const s = JSON.parse(raw);
        return {
          settings: { ...defaultState().settings, ...(s.settings||{}) },
          items: Array.isArray(s.items) ? s.items : []
        };
      }catch{
        return defaultState();
      }
    }

    let state = loadState();
    function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }

    const $ = (id) => document.getElementById(id);
    const esc = (s)=> String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    const n = (v, def=0) => { const x = Number(v); return Number.isFinite(x) ? x : def; };

    const dateRe = /^(\d{4})\.(\d{1,2})\.(\d{1,2})$/;
    function toISO(dateStr){
      const m = String(dateStr||"").trim().match(dateRe);
      if(!m) return "";
      const y = m[1];
      const mo = String(m[2]).padStart(2,"0");
      const d = String(m[3]).padStart(2,"0");
      return `${y}-${mo}-${d}`;
    }
    function prettyISO(iso){
      if(!iso) return "";
      const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return iso;
      return `${m[1]}.${Number(m[2])}.${Number(m[3])}`;
    }

    function isBought(s){
      const t = String(s||"").trim().toUpperCase();
      if(!t) return false;
      if(t === "YES" || t === "Y" || t === "TRUE" || t === "1") return true;
      const raw = String(s||"").trim();
      return /已买|已購|已购|购票|購入|確保|PAID|BOUGHT|PURCHASED/i.test(raw);
    }
    function isBookedTransport(s){
      const raw = String(s||"").trim();
      if(!raw) return false;
      const t = raw.toUpperCase();
      if(t === "YES" || t === "Y" || t === "TRUE" || t === "1") return true;
      return /已买|已訂|已订|已定|予約|確保|済|PAID|BOOKED/i.test(raw);
    }

    function sortItems(items){
      const pinned = (x)=> (String(x.pinned||"NO").toUpperCase()==="YES");
      const iso = (x)=> x.dateISO || toISO(x.date||"") || "";
      return items.slice().sort((a,b)=>{
        const pa = pinned(a), pb = pinned(b);
        if(pa !== pb) return pa ? -1 : 1;
        const ia = iso(a), ib = iso(b);
        if(ia && ib) return ia.localeCompare(ib);
        return String(a.date||"").localeCompare(String(b.date||""));
      });
    }

    function filtered(){
      const s = state.settings;
      const year = String(s.yearFilter||"ALL");
      const city = String(s.cityFilter||"").trim();
      const status = String(s.statusFilter||"ALL");
      const q = String(s.q||"").trim().toLowerCase();

      const out = [];
      for(const it of state.items){
        const iso = it.dateISO || toISO(it.date||"");
        const y = iso ? iso.slice(0,4) : "";

        if(year !== "ALL" && y !== year) continue;
        if(city && !String(it.city||"").includes(city)) continue;

        const bought = isBought(it.ticketStatus);
        if(status === "BOUGHT" && !bought) continue;
        if(status === "NEED" && bought) continue;

        if(q){
          const hay = [
            it.date, it.event, it.city, it.venue, it.transport,
            it.transportStatus, it.seat, it.ticketStatus, it.lodging
          ].join(" ").toLowerCase();
          if(!hay.includes(q)) continue;
        }

        out.push({...it, dateISO: iso || it.dateISO || ""});
      }
      return sortItems(out);
    }

    function renderYearOptions(){
      const set = new Set();
      for(const it of state.items){
        const iso = it.dateISO || toISO(it.date||"");
        if(iso) set.add(iso.slice(0,4));
      }
      const years = Array.from(set).sort();
      const sel = $("yearFilter");
      const cur = String(state.settings.yearFilter||"ALL");
      sel.innerHTML = `<option value="ALL">全部</option>` + years.map(y=>`<option value="${esc(y)}">${esc(y)}</option>`).join("");
      sel.value = years.includes(cur) ? cur : "ALL";
      state.settings.yearFilter = sel.value;
    }

    function renderKpis(list){
      let total = list.length;
      const cities = new Set(list.map(x=>String(x.city||"").trim()).filter(Boolean));
      const bought = list.filter(x=>isBought(x.ticketStatus)).length;
      const transport = list.filter(x=>isBookedTransport(x.transportStatus) || isBookedTransport(x.transport)).length;
      const withHotel = list.filter(x=>String(x.lodging||"").trim().length>0).length;

      const isos = list.map(x=>x.dateISO).filter(Boolean).sort();
      const first = isos[0] ? prettyISO(isos[0]) : "—";
      const last = isos[isos.length-1] ? prettyISO(isos[isos.length-1]) : "—";

      const kpis = [
        {k:"条目数", v: total},
        {k:"城市数", v: cities.size},
        {k:"票务已买", v: bought},
        {k:"交通已定", v: transport},
        {k:"住宿/备注非空", v: withHotel},
        {k:"日期范围", v: `${first} → ${last}`}
      ];

      $("kpis").innerHTML = kpis.map(x=>`
        <div class="kpi">
          <div class="k">${esc(x.k)}</div>
          <div class="v">${esc(x.v)}</div>
        </div>
      `).join("");
    }

    function setPinToggle(v){
      const val = String(v||'NO').toUpperCase()==='YES' ? 'YES' : 'NO';
      document.querySelectorAll('#pinToggle button').forEach(b=>{
        b.classList.toggle('active', b.getAttribute('data-v') === val);
      });
    }
    function getPinFromToggle(){
      const el = document.querySelector('#pinToggle button.active');
      return el ? el.getAttribute('data-v') : 'NO';
    }
    document.getElementById('pinToggle').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-v]');
      if(!btn) return;
      setPinToggle(btn.getAttribute('data-v'));
    });

    function renderTable(list){
      const tb = $("tbody");

      tb.innerHTML = list.map((it, idx)=> {
        const bought = isBought(it.ticketStatus);
        const booked = isBookedTransport(it.transportStatus) || isBookedTransport(it.transport);
        const pin = String(it.pinned||"NO").toUpperCase()==="YES";

        const dateShow = it.dateISO ? prettyISO(it.dateISO) : String(it.date||"");

        return `
          <tr data-id="${esc(it.id)}">
            <td>${idx+1}</td>
            <td contenteditable="true" data-k="date">${esc(dateShow)}</td>
            <td contenteditable="true" data-k="event">${esc(it.event||"")}</td>
            <td contenteditable="true" data-k="city"><span class="pill">${esc(it.city||"")}</span></td>
            <td contenteditable="true" data-k="venue">${esc(it.venue||"")}</td>
            <td contenteditable="true" data-k="transport">${esc(it.transport||"")}</td>
            <td contenteditable="true" data-k="transportStatus" class="${booked?'min-ok':''}">${esc(it.transportStatus||"")}</td>
            <td contenteditable="true" data-k="seat">${esc(it.seat||"")}</td>
            <td contenteditable="true" data-k="ticketStatus" class="${bought?'min-ok':'min-warn'}">${esc(it.ticketStatus||"")}</td>
            <td contenteditable="true" data-k="lodging">${esc(it.lodging||"")}</td>
            <td>
              <div class="toggle small" data-k="pinnedToggleRow">
                <button type="button" data-v="NO" class="${pin ? '' : 'active'}">NO</button>
                <button type="button" data-v="YES" class="${pin ? 'active' : ''}">YES</button>
              </div>
            </td>
            <td><button class="btn ghost" data-act="del">删除</button></td>
          </tr>
        `;
      }).join("");

      tb.querySelectorAll('button[data-act="del"]').forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          const tr = e.target.closest("tr");
          const id = tr?.getAttribute("data-id");
          if(!id) return;
          state.items = state.items.filter(x=>x.id !== id);
          saveState();
          render();
        });
      });

      tb.querySelectorAll('[data-k="pinnedToggleRow"]').forEach(box=>{
        box.addEventListener('click', (e)=>{
          const btn = e.target.closest('button[data-v]');
          if(!btn) return;
          const tr = e.target.closest('tr');
          const id = tr?.getAttribute('data-id');
          if(!id) return;
          const it = state.items.find(x=>x.id === id);
          if(!it) return;
          it.pinned = btn.getAttribute('data-v');
          saveState();
          render();
        });
      });

      tb.querySelectorAll('[contenteditable="true"]').forEach(cell=>{
        cell.addEventListener("blur", (e)=>{
          const td = e.target;
          const tr = td.closest("tr");
          const id = tr.getAttribute("data-id");
          const k = td.getAttribute("data-k");
          const val = td.innerText.trim();

          const it = state.items.find(x=>x.id === id);
          if(!it) return;

          if(k === "date"){
            // 允许用户编辑为 2025.7.26 或 2025-07-26
            const v = val.replace(/\//g,"-");
            if(dateRe.test(v)){
              it.date = v;
              it.dateISO = toISO(v);
            }else if(/^\d{4}-\d{2}-\d{2}$/.test(v)){
              it.dateISO = v;
              it.date = prettyISO(v);
            }else{
              it.date = val; // 仍保存，但无法参与年份筛选/排序
              it.dateISO = toISO(val);
            }
          }else{
            it[k] = val;
          }

          saveState();
          render();
        });
      });
    }

    function syncSettingsToUI(){
      $("yearFilter").value = String(state.settings.yearFilter||"ALL");
      $("cityFilter").value = String(state.settings.cityFilter||"");
      $("statusFilter").value = String(state.settings.statusFilter||"ALL");
      $("q").value = String(state.settings.q||"");
    }

    function syncUIToSettings(){
      state.settings.yearFilter = String($("yearFilter").value || "ALL");
      state.settings.cityFilter = String($("cityFilter").value || "");
      state.settings.statusFilter = String($("statusFilter").value || "ALL");
      state.settings.q = String($("q").value || "");
      saveState();
      render();
    }

    ["yearFilter","cityFilter","statusFilter","q"].forEach(id=>{
      $(id).addEventListener("input", syncUIToSettings);
      $(id).addEventListener("change", syncUIToSettings);
    });

    function addItem(){
      const date = String($("date").value||"").trim();
      const dateISO = toISO(date);

      const it = {
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random()),
        date: date,
        dateISO: dateISO,
        event: String($("event").value||"").trim(),
        city: String($("city").value||"").trim(),
        venue: String($("venue").value||"").trim(),
        transport: String($("transport").value||"").trim(),
        transportStatus: String($("transportStatus").value||"").trim(),
        seat: String($("seat").value||"").trim(),
        ticketStatus: String($("ticketStatus").value||"").trim(),
        lodging: String($("lodging").value||"").trim(),
        pinned: getPinFromToggle()
      };

      if(!it.date && !it.event && !it.city) return;
      state.items.unshift(it);
      saveState();
      render();
    }

    $("btnAdd").addEventListener("click", addItem);

    $("btnAddToday").addEventListener("click", ()=>{
      const d = new Date();
      const y = d.getFullYear();
      const m = d.getMonth()+1;
      const dd = d.getDate();
      $("date").value = `${y}.${m}.${dd}`;
    });

    $("btnExport").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "genchi-plan.json";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    $("btnImport").addEventListener("click", ()=>{
      const inp = document.createElement("input");
      inp.type = "file"; inp.accept = "application/json";
      inp.onchange = async () => {
        const f = inp.files && inp.files[0];
        if(!f) return;
        try{
          const s = JSON.parse(await f.text());
          state = {
            settings: { ...defaultState().settings, ...(s.settings||{}) },
            items: Array.isArray(s.items) ? s.items : []
          };
          saveState();
          render();
        }catch(e){
          alert("JSON 解析失败：" + (e?.message || e));
        }
      };
      inp.click();
    });

    $("btnReset").addEventListener("click", ()=>{
      if(!confirm("确定重置？会清空本机保存数据。")) return;
      state = defaultState();
      saveState();
      render();
    });

    // Excel import (headerless)
    function excelToItems(wb){
      const sheetName = wb.SheetNames[0];
      if(!sheetName) throw new Error("找不到 Sheet");
      const ws = wb.Sheets[sheetName];

      const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
      const out = [];

      for(let i=0;i<rows.length;i++){
        const r = rows[i] || [];
        const date = String(r[0] ?? "").trim();
        if(!dateRe.test(date)) continue;

        out.push({
          id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random()),
          date,
          dateISO: toISO(date),
          event: String(r[1] ?? "").trim(),
          city: String(r[2] ?? "").trim(),
          venue: String(r[3] ?? "").trim(),
          transport: String(r[4] ?? "").trim(),
          transportStatus: String(r[5] ?? "").trim(),
          seat: String(r[6] ?? "").trim(),
          ticketStatus: String(r[7] ?? "").trim(),
          lodging: String(r[8] ?? "").trim(),
          pinned: "NO"
        });
      }
      return out;
    }

    $("btnImportExcel").addEventListener("click", ()=> $("excelFile").click());
    $("excelFile").addEventListener("change", async (e)=>{
      const f = e.target.files && e.target.files[0];
      e.target.value = "";
      if(!f) return;

      try{
        const ab = await f.arrayBuffer();
        const wb = XLSX.read(ab, {type:"array"});
        const items = excelToItems(wb);
        if(items.length === 0){
          alert("未识别到可导入的行：需要 A 列为 YYYY.M.D。");
          return;
        }
        state.items = items.concat(state.items);
        saveState();
        render();
      }catch(err){
        alert("Excel 导入失败：" + (err?.message || err));
      }
    });

    async function loadAvatar(){
      const img = $("avatarImg");
      const fb = $("avatarFallback");

      const src = "./avatar.jpg?v=" + Date.now();
      img.onload = ()=>{
        img.style.display = "block";
        fb.style.display = "none";
      };
      img.onerror = ()=>{
        img.style.display = "none";
        fb.style.display = "block";
      };
      img.src = src;
    }

    function render(){
      renderYearOptions();
      syncSettingsToUI();
      const list = filtered();
      renderKpis(list);
      renderTable(list);
    }

    // Init
    setPinToggle("NO");
    loadAvatar();
    render();
  </script>
</body>
</html>

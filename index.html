<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>ç°åœ°è®¡åˆ’åŠ©æ‰‹</title>
  <style>
    :root{
      --bg:#0b1020; --bg2:#070a14;
      --card: rgba(18,26,51,.92);
      --text:#e8ecff; --muted:#a9b2d6;
      --line: rgba(255,255,255,.10);
      --ok:#6ef2b6; --warn:#ffd27a; --bad:#ff8a8a; --info:#86b7ff;
      --btn1:#2b3a75; --btn2:#1e2a55;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --r:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 700px at 10% 0%, rgba(86,120,255,.22), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(110,242,182,.16), transparent 60%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    a{color:inherit}
    .wrap{max-width:1180px; margin:0 auto; padding:20px 14px 28px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .avatar{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, rgba(134,183,255,.35), rgba(110,242,182,.22));
      border:1px solid var(--line);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      overflow:hidden; flex:0 0 auto;
      display:grid; place-items:center;
      font-weight:800; letter-spacing:.5px;
    }
    .avatar img{width:100%; height:100%; object-fit:cover; display:block}
    .titlebox{line-height:1.05}
    .title{font-weight:800; font-size:15px}
    .subtitle{color:var(--muted); font-size:12px; margin-top:4px}
    .pill{
      font-family:var(--mono);
      font-size:11px; color:var(--muted);
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }

    .panel{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .hd h2{margin:0; font-size:13px; letter-spacing:.2px}
    .hd .hint{color:var(--muted); font-size:12px}
    .panel .bd{padding:12px 14px}

    /* top form: stacked layout */
    .grid{
      display:grid;
      grid-template-columns: 1.1fr 1.1fr 1fr 1.1fr;
      gap:10px;
    }
    .grid .full{grid-column:1 / -1}
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:11px; color:var(--muted)}
    input, select, textarea{
      background: rgba(0,0,0,.18);
      color:var(--text);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:9px 10px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:40px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color: rgba(134,183,255,.55); box-shadow: 0 0 0 3px rgba(134,183,255,.12)}
    .btnrow{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    button{
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, var(--btn1), var(--btn2));
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    button.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-weight:650;
    }
    button.danger{
      background: rgba(255,90,90,.12);
      border:1px solid rgba(255,90,90,.30);
    }
    button:active{transform: translateY(1px)}
    .file{display:none}
    .kpis{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    .kpi{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.035);
      min-height:58px;
    }
    .kpi .k{color:var(--muted); font-size:11px}
    .kpi .v{font-size:18px; font-weight:850; margin-top:5px; font-family:var(--mono)}
    .kpi .s{color:var(--muted); font-size:11px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* bottom list: compact rows, no horizontal scroll */
    .toolbar{
      display:flex; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .toolbar .left, .toolbar .right{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .search{
      width:min(440px, 100%);
      display:flex; gap:8px; align-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 12px;
      padding: 8px 10px;
    }
    .search input{border:none; background:transparent; padding:0; font-size:13px; width:100%}
    .rows{display:flex; flex-direction:column; gap:8px}
    .row{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:9px 10px;
      display:grid;
      grid-template-columns: 112px 1fr 160px;
      gap:10px;
      align-items:start;
    }
    .row .date{
      font-family: var(--mono);
      font-size:12px;
      color: var(--text);
      padding-top:2px;
      white-space:nowrap;
    }
    .row .main{min-width:0}
    .row .event{
      font-size:13px;
      font-weight:800;
      line-height:1.15;
      word-break:break-word;
    }
    .row .meta{
      margin-top:4px;
      color: var(--muted);
      font-size:12px;
      line-height:1.2;
      word-break:break-word;
    }
    .row .right{
      display:flex; flex-direction:column; gap:6px; align-items:flex-end;
    }
    .badges{display:flex; flex-wrap:wrap; gap:6px; justify-content:flex-end}
    .badge{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      max-width: 100%;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .badge.ok{color: rgba(110,242,182,.98); border-color: rgba(110,242,182,.25); background: rgba(110,242,182,.08)}
    .badge.warn{color: rgba(255,210,122,.98); border-color: rgba(255,210,122,.25); background: rgba(255,210,122,.08)}
    .badge.bad{color: rgba(255,138,138,.98); border-color: rgba(255,138,138,.25); background: rgba(255,138,138,.08)}
    .badge.info{color: rgba(134,183,255,.98); border-color: rgba(134,183,255,.25); background: rgba(134,183,255,.08)}
    .actions{display:flex; gap:8px; justify-content:flex-end}
    .iconbtn{
      padding:7px 9px;
      border-radius:12px;
      font-size:12px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
      color: var(--text);
    }
    .iconbtn.danger{background: rgba(255,90,90,.12); border-color: rgba(255,90,90,.30)}
    .editable{border-bottom:1px dashed rgba(255,255,255,.25); padding-bottom:1px; outline:none}
    .muted{color:var(--muted)}
    .footerhint{color:var(--muted); font-size:12px; margin-top:10px}

    @media (max-width: 960px){
      .grid{grid-template-columns: 1fr 1fr}
      .kpis{grid-template-columns: repeat(3, minmax(0,1fr))}
    }
    @media (max-width: 680px){
      .row{grid-template-columns: 96px 1fr; }
      .row .right{grid-column: 1 / -1; align-items:flex-start}
      .badges{justify-content:flex-start}
      .actions{justify-content:flex-start}
      .kpis{grid-template-columns: repeat(2, minmax(0,1fr))}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="avatar" id="avatarBox" aria-label="avatar">
          <img src="./avatar.jpg" alt="avatar" onerror="this.remove(); document.getElementById('avatarBox').textContent='CN';" />
        </div>
        <div class="titlebox">
          <div class="title">Copper Nickel Â· ç°åœ°è®¡åˆ’</div>
          <div class="subtitle">ä¸Šæ–¹æ·»åŠ  / ç­›é€‰ Â· ä¸‹æ–¹ç´§å‡‘åˆ—è¡¨ï¼ˆæ— æ¨ªå‘æ»šåŠ¨ï¼‰</div>
        </div>
      </div>
      <div class="pill" id="savePill">localStorage: æœªä¿å­˜</div>
    </div>

    <!-- TOP: add & options -->
    <div class="panel" style="margin-bottom:12px">
      <div class="hd">
        <h2>é€‰é¡¹åŒº Â· æ·»åŠ æ–°è¡Œç¨‹</h2>
        <div class="hint">æ·»åŠ åè‡ªåŠ¨ä¿å­˜ï¼›æ‰€æœ‰å­—æ®µå¯åœ¨ä¸‹æ–¹è¡Œç¨‹ä¸­ç›´æ¥ç¼–è¾‘</div>
      </div>
      <div class="bd">
        <div class="grid" id="addGrid">
          <div class="field">
            <label>æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰</label>
            <input id="fDateISO" type="date" />
          </div>
          <div class="field">
            <label>æ—¶é—´ï¼ˆå¯é€‰ï¼Œä¾‹å¦‚ 18:30ï¼‰</label>
            <input id="fTime" placeholder="18:30" />
          </div>
          <div class="field">
            <label>åœ°åŒº / åŸå¸‚</label>
            <input id="fCity" placeholder="ä¸œäº¬ / ä¸Šæµ· / åŒ—äº¬â€¦" />
          </div>
          <div class="field">
            <label>ç¥¨åŠ¡çŠ¶æ€</label>
            <select id="fTicket">
              <option value="">ï¼ˆç©ºï¼‰</option>
              <option>å¾…å¼€ç¥¨</option>
              <option>å¾…æŠ½é€‰</option>
              <option>ç­‰æ”¶ç¥¨</option>
              <option>å·²ä¹°</option>
              <option>å·²æ”¶åˆ°</option>
              <option>æœªä¸­ç­¾</option>
            </select>
          </div>

          <div class="field full">
            <label>Live / æ´»åŠ¨åç§°</label>
            <input id="fEvent" placeholder="ä¾‹å¦‚ï¼šMyGO!!!!!Ã—Ave Mujica åˆåŒãƒ©ã‚¤ãƒ–â€¦" />
          </div>

          <div class="field full">
            <label>åœºé¦†</label>
            <input id="fVenue" placeholder="ä¾‹å¦‚ï¼šKã‚¢ãƒªãƒ¼ãƒŠæ¨ªæµœ / æµ¦å‘é“¶è¡Œä¸œæ–¹ä½“è‚²ä¸­å¿ƒâ€¦" />
          </div>

          <div class="field">
            <label>äº¤é€šæ–¹å¼ / èˆªç­è½¦æ¬¡</label>
            <input id="fTransport" placeholder="ä¾‹å¦‚ï¼šNH96X / T109 / è‡ªé©¾â€¦" />
          </div>
          <div class="field">
            <label>äº¤é€šçŠ¶æ€</label>
            <select id="fTransportStatus">
              <option value="">ï¼ˆç©ºï¼‰</option>
              <option>å¾…è´­ä¹°</option>
              <option>å·²ä¹°</option>
              <option>å·²å®š</option>
              <option>å¾…ç¡®è®¤</option>
            </select>
          </div>
          <div class="field">
            <label>åº§ä½</label>
            <input id="fSeat" placeholder="Så¸­ / VIP / çœ‹å°â€¦" />
          </div>
          <div class="field">
            <label>ä½å®¿</label>
            <input id="fLodging" placeholder="é…’åº—/æœ‹å‹å®¶/å¾…å®šâ€¦" />
          </div>

          <div class="field full">
            <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
            <textarea id="fNote" placeholder="ä¾‹å¦‚ï¼šå–ç¥¨çª—å£/å…¥åœºæ³¨æ„äº‹é¡¹/åŒè¡Œäººâ€¦"></textarea>
          </div>

          <div class="btnrow full">
            <button id="btnAdd">æ·»åŠ è¡Œç¨‹</button>
            <button class="secondary" id="btnClear">æ¸…ç©ºè¾“å…¥</button>
            <span class="muted" style="font-size:12px">æç¤ºï¼šæ—¥æœŸä¸ºç©ºæ—¶ä¸ä¼šæ·»åŠ </span>

            <span style="flex:1"></span>

            <input class="file" id="fileJson" type="file" accept="application/json" />
            <input class="file" id="fileXlsx" type="file" accept=".xlsx,.xls" />
            <button class="secondary" id="btnImportJson">å¯¼å…¥JSON</button>
            <button class="secondary" id="btnExportJson">å¯¼å‡ºJSON</button>
            <button class="secondary" id="btnImportXlsx">ä» Excel å¯¼å…¥</button>
            <button class="danger" id="btnReset">é‡ç½®ï¼ˆæ¸…ç©ºæœ¬åœ°ï¼‰</button>
          </div>
        </div>

        <div class="kpis" id="kpiBox"></div>
      </div>
    </div>

    <!-- BOTTOM: main list -->
    <div class="panel">
      <div class="hd">
        <h2>è¡Œç¨‹ä¸»è¡¨</h2>
        <div class="hint">ç‚¹å‡»ä¸‹æ–¹å¸¦è™šçº¿çš„å­—æ®µå³å¯ç¼–è¾‘ï¼›å›è½¦/ç‚¹å‡»ç©ºç™½å¤„è‡ªåŠ¨ä¿å­˜</div>
      </div>
      <div class="bd">
        <div class="toolbar">
          <div class="left">
            <div class="search" title="å…³é”®è¯ï¼šæ´»åŠ¨ / åœºé¦† / åŸå¸‚ / äº¤é€š / åº§ä½ / ä½å®¿">
              <span class="muted" style="font-family:var(--mono);font-size:12px">ğŸ”</span>
              <input id="q" placeholder="æœç´¢â€¦" />
            </div>
            <select id="yearFilter">
              <option value="ALL">å…¨éƒ¨å¹´ä»½</option>
            </select>
            <select id="cityFilter">
              <option value="ALL">å…¨éƒ¨åœ°åŒº</option>
            </select>
            <select id="ticketFilter">
              <option value="ALL">å…¨éƒ¨ç¥¨åŠ¡çŠ¶æ€</option>
              <option value="">ï¼ˆç©ºï¼‰</option>
              <option>å¾…å¼€ç¥¨</option>
              <option>å¾…æŠ½é€‰</option>
              <option>ç­‰æ”¶ç¥¨</option>
              <option>å·²ä¹°</option>
              <option>å·²æ”¶åˆ°</option>
              <option>æœªä¸­ç­¾</option>
            </select>
            <select id="sortBy">
              <option value="dateAsc">æŒ‰æ—¥æœŸâ†‘</option>
              <option value="dateDesc">æŒ‰æ—¥æœŸâ†“</option>
              <option value="cityAsc">æŒ‰åœ°åŒºAâ†’Z</option>
              <option value="cityDesc">æŒ‰åœ°åŒºZâ†’A</option>
            </select>
          </div>
          <div class="right">
            <span class="pill" id="countPill">0 items</span>
          </div>
        </div>

        <div class="rows" id="rows"></div>
        <div class="footerhint">æ— æ¨ªå‘æ»šåŠ¨ï¼šä¿¡æ¯ä¼šè‡ªåŠ¨æ¢è¡Œã€‚éœ€è¦æ›´â€œæŒ¤â€çš„å¯†åº¦æˆ‘ä¹Ÿå¯ä»¥ç»§ç»­å‹ç¼©å­—å·/é—´è·ã€‚</div>
      </div>
    </div>
  </div>

<script>
(function(){
  const LS_KEY = "genchi_plan_ready_v2";
  const $ = (id)=>document.getElementById(id);

  const state = {
    settings: {
      yearFilter: "ALL",
      cityFilter: "ALL",
      ticketFilter: "ALL",
      q: "",
      sortBy: "dateAsc"
    },
    items: []
  };

  // ---------- helpers ----------
  const pad2 = (n)=>String(n).padStart(2,"0");
  function isoToDisplay(iso){
    if(!iso) return "";
    const [y,m,d] = iso.split("-").map(x=>parseInt(x,10));
    if(!y||!m||!d) return "";
    return `${y}.${m}.${d}`;
  }
  function displayToISO(s){
    // accept YYYY.M.D or YYYY.MM.DD
    if(!s) return "";
    const m = String(s).trim().match(/^(\d{4})\.(\d{1,2})\.(\d{1,2})$/);
    if(!m) return "";
    const y=+m[1], mo=+m[2], d=+m[3];
    return `${y}-${pad2(mo)}-${pad2(d)}`;
  }
  function genId(){
    return "r" + Math.random().toString(36).slice(2,9);
  }
  function norm(s){ return (s??"").toString().trim(); }
  function contains(hay, needle){ return hay.toLowerCase().includes(needle.toLowerCase()); }

  function badgeClass(val){
    const v = norm(val);
    if(!v) return "badge";
    const ok = ["å·²ä¹°","å·²å®š","å·²æ”¶åˆ°"];
    const warn = ["å¾…å¼€ç¥¨","å¾…æŠ½é€‰","å¾…è´­ä¹°","å¾…ç¡®è®¤","ç­‰æ”¶ç¥¨","å¾…å®š"];
    const bad = ["æœªä¸­ç­¾"];
    if(ok.includes(v)) return "badge ok";
    if(bad.includes(v)) return "badge bad";
    if(warn.includes(v)) return "badge warn";
    return "badge info";
  }

  // ---------- persistence ----------
  function setSavePill(text){
    const el = $("savePill");
    el.textContent = text;
  }
  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    setSavePill("localStorage: å·²ä¿å­˜ " + new Date().toLocaleString());
  }
  function load(){
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      try{
        const obj = JSON.parse(raw);
        if(obj && obj.items) {
          state.items = obj.items;
          state.settings = Object.assign(state.settings, obj.settings || {});
        }
      }catch(e){}
    }else{
      // try load bundled starter json on first open
      fetch("./starter_from_excel.json").then(r=>r.ok?r.json():null).then(obj=>{
        if(obj && obj.items){
          state.items = obj.items;
          renderAll();
          save();
        }
      }).catch(()=>{});
    }
  }

  // ---------- computed ----------
  function filteredItems(){
    let items = [...state.items];

    // sort
    const sortBy = state.settings.sortBy;
    items.sort((a,b)=>{
      const da = a.dateISO || displayToISO(a.date) || "";
      const db = b.dateISO || displayToISO(b.date) || "";
      if(sortBy==="dateAsc") return da.localeCompare(db);
      if(sortBy==="dateDesc") return db.localeCompare(da);
      if(sortBy==="cityAsc") return (a.city||"").localeCompare(b.city||"");
      if(sortBy==="cityDesc") return (b.city||"").localeCompare(a.city||"");
      return 0;
    });

    // year filter
    const yf = state.settings.yearFilter;
    if(yf!=="ALL"){
      items = items.filter(it=>{
        const iso = it.dateISO || displayToISO(it.date);
        return iso && iso.startsWith(yf + "-");
      });
    }
    // city
    const cf = state.settings.cityFilter;
    if(cf!=="ALL"){
      items = items.filter(it=>norm(it.city)===cf);
    }
    // ticket
    const tf = state.settings.ticketFilter;
    if(tf!=="ALL"){
      items = items.filter(it=>norm(it.ticketStatus)===tf);
    }
    // q
    const q = norm(state.settings.q);
    if(q){
      items = items.filter(it=>{
        const blob = [
          it.event,it.venue,it.city,it.transport,it.transportStatus,it.seat,it.ticketStatus,it.lodging,it.time,it.note
        ].map(x=>norm(x)).join(" | ");
        return contains(blob, q);
      });
    }

    return items;
  }

  function computeKPI(items){
    const total = items.length;
    const cities = new Set(items.map(x=>norm(x.city)).filter(Boolean));
    const ticketBought = items.filter(x=>norm(x.ticketStatus)==="å·²ä¹°" || norm(x.ticketStatus)==="å·²æ”¶åˆ°").length;
    const transportDone = items.filter(x=>["å·²ä¹°","å·²å®š"].includes(norm(x.transportStatus))).length;
    const lodgingFilled = items.filter(x=>norm(x.lodging)).length;

    const dates = items.map(x=>x.dateISO || displayToISO(x.date)).filter(Boolean).sort();
    const range = dates.length? `${dates[0]} ~ ${dates[dates.length-1]}` : "â€”";

    const next = (()=> {
      const today = new Date();
      const tIso = today.toISOString().slice(0,10);
      const upcoming = items
        .map(x=>({iso: x.dateISO || displayToISO(x.date), it:x}))
        .filter(x=>x.iso && x.iso>=tIso)
        .sort((a,b)=>a.iso.localeCompare(b.iso))[0];
      if(!upcoming) return "â€”";
      const it = upcoming.it;
      return `${upcoming.iso} Â· ${(it.city||"").trim()} Â· ${(it.event||"").trim()}`.trim();
    })();

    return [
      {k:"æ¡ç›®", v: total, s:"å½“å‰ç­›é€‰ç»“æœ"},
      {k:"åœ°åŒºæ•°", v: cities.size, s:[...cities].slice(0,3).join(" / ") + (cities.size>3?"â€¦":"")},
      {k:"ç¥¨åŠ¡å·²ä¹°/å·²æ”¶", v: ticketBought, s:"ticketStatus âˆˆ {å·²ä¹°, å·²æ”¶åˆ°}"},
      {k:"äº¤é€šå·²å®š/å·²ä¹°", v: transportDone, s:"transportStatus âˆˆ {å·²å®š, å·²ä¹°}"},
      {k:"ä½å®¿æœ‰å€¼", v: lodgingFilled, s:"lodging éç©º"},
      {k:"æ—¥æœŸèŒƒå›´ / ä¸‹ä¸€åœº", v: " ", s: range + "  |  Next: " + next}
    ];
  }

  // ---------- render ----------
  function rebuildFilters(){
    // year options
    const years = [...new Set(state.items.map(it=>{
      const iso = it.dateISO || displayToISO(it.date);
      return iso ? iso.slice(0,4) : "";
    }).filter(Boolean))].sort();
    const yearSel = $("yearFilter");
    yearSel.innerHTML = `<option value="ALL">å…¨éƒ¨å¹´ä»½</option>` + years.map(y=>`<option value="${y}">${y}</option>`).join("");

    // city options
    const cities = [...new Set(state.items.map(it=>norm(it.city)).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    const citySel = $("cityFilter");
    citySel.innerHTML = `<option value="ALL">å…¨éƒ¨åœ°åŒº</option>` + cities.map(c=>`<option value="${c}">${c}</option>`).join("");

    // apply selection
    yearSel.value = state.settings.yearFilter;
    citySel.value = state.settings.cityFilter;
    $("ticketFilter").value = state.settings.ticketFilter;
    $("q").value = state.settings.q;
    $("sortBy").value = state.settings.sortBy;
  }

  function renderKPI(items){
    const box = $("kpiBox");
    const kpis = computeKPI(items);
    box.innerHTML = kpis.map(x=>{
      const vv = (x.v===" ") ? "" : x.v;
      return `<div class="kpi">
        <div class="k">${x.k}</div>
        <div class="v">${vv}</div>
        <div class="s">${x.s}</div>
      </div>`;
    }).join("");
  }

  function renderRows(items){
    const rows = $("rows");
    $("countPill").textContent = `${items.length} items`;

    rows.innerHTML = items.map(it=>{
      const iso = it.dateISO || displayToISO(it.date) || "";
      const disp = it.date || isoToDisplay(iso) || "";
      const city = norm(it.city);
      const venue = norm(it.venue);
      const time = norm(it.time);
      const event = norm(it.event);

      const badges = [
        ["ç¥¨åŠ¡", it.ticketStatus],
        ["äº¤é€š", it.transportStatus],
        ["æ–¹å¼", it.transport],
        ["åº§ä½", it.seat],
        ["ä½å®¿", it.lodging],
      ].filter(x=>norm(x[1])).map(([k,v])=>{
        return `<span class="${badgeClass(v)}" title="${k}: ${escapeHtml(v)}">${k}:${escapeHtml(v)}</span>`;
      }).join("");

      const metaParts = [];
      metaParts.push(city ? `ğŸ“ <span class="editable" data-id="${it.id}" data-k="city" contenteditable="true">${escapeHtml(city)}</span>` : `ğŸ“ <span class="editable" data-id="${it.id}" data-k="city" contenteditable="true">ï¼ˆåœ°åŒºï¼‰</span>`);
      metaParts.push(venue ? `ğŸŸï¸ <span class="editable" data-id="${it.id}" data-k="venue" contenteditable="true">${escapeHtml(venue)}</span>` : `ğŸŸï¸ <span class="editable" data-id="${it.id}" data-k="venue" contenteditable="true">ï¼ˆåœºé¦†ï¼‰</span>`);
      if(time) metaParts.push(`ğŸ•’ <span class="editable" data-id="${it.id}" data-k="time" contenteditable="true">${escapeHtml(time)}</span>`);
      const note = norm(it.note);
      if(note) metaParts.push(`ğŸ“ <span class="editable" data-id="${it.id}" data-k="note" contenteditable="true">${escapeHtml(note)}</span>`);

      return `<div class="row" data-row="${it.id}">
        <div class="date">
          <div><span class="editable" data-id="${it.id}" data-k="dateISO" contenteditable="true">${escapeHtml(iso||"")}</span></div>
          <div class="muted" style="margin-top:4px"><span class="editable" data-id="${it.id}" data-k="date" contenteditable="true">${escapeHtml(disp||"")}</span></div>
        </div>
        <div class="main">
          <div class="event"><span class="editable" data-id="${it.id}" data-k="event" contenteditable="true">${escapeHtml(event||"ï¼ˆæ´»åŠ¨åç§°ï¼‰")}</span></div>
          <div class="meta">${metaParts.join(" Â· ")}</div>
        </div>
        <div class="right">
          <div class="badges">${badges || `<span class="badge muted">ï¼ˆæš‚æ— çŠ¶æ€ï¼‰</span>`}</div>
          <div class="actions">
            <button class="iconbtn" data-act="dup" data-id="${it.id}">å¤åˆ¶</button>
            <button class="iconbtn danger" data-act="del" data-id="${it.id}">åˆ é™¤</button>
          </div>
        </div>
      </div>`;
    }).join("");

    // mark editables
    rows.querySelectorAll(".editable").forEach(el=>{
      el.classList.add("editable");
      el.addEventListener("keydown", (e)=>{
        if(e.key==="Enter"){
          e.preventDefault();
          el.blur();
        }
      });
      el.addEventListener("blur", ()=>{
        const id = el.getAttribute("data-id");
        const k = el.getAttribute("data-k");
        const v = el.textContent.trim();
        const it = state.items.find(x=>x.id===id);
        if(!it) return;

        if(k==="dateISO"){
          // accept YYYY-MM-DD; also if user enters YYYY.M.D convert
          let iso = v;
          if(v.includes(".")) iso = displayToISO(v);
          if(iso && !/^\d{4}-\d{2}-\d{2}$/.test(iso)) iso = "";
          it.dateISO = iso;
          if(iso) it.date = isoToDisplay(iso);
        }else if(k==="date"){
          it.date = v;
          const iso = displayToISO(v);
          if(iso) it.dateISO = iso;
        }else{
          it[k] = v;
        }
        save();
        // refresh dependent filters/kpis
        renderAll(false);
      });
    });
  }

  function escapeHtml(str){
    return (str??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  function renderAll(rebuild=true){
    if(rebuild) rebuildFilters();
    const items = filteredItems();
    renderKPI(items);
    renderRows(items);
  }

  // ---------- events ----------
  function bind(){
    // filters
    $("q").addEventListener("input", (e)=>{ state.settings.q = e.target.value; save(); renderAll(false); });
    $("yearFilter").addEventListener("change", (e)=>{ state.settings.yearFilter = e.target.value; save(); renderAll(false); });
    $("cityFilter").addEventListener("change", (e)=>{ state.settings.cityFilter = e.target.value; save(); renderAll(false); });
    $("ticketFilter").addEventListener("change", (e)=>{ state.settings.ticketFilter = e.target.value; save(); renderAll(false); });
    $("sortBy").addEventListener("change", (e)=>{ state.settings.sortBy = e.target.value; save(); renderAll(false); });

    // row actions
    $("rows").addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");
      const idx = state.items.findIndex(x=>x.id===id);
      if(idx<0) return;
      if(act==="del"){
        if(confirm("åˆ é™¤è¯¥æ¡è¡Œç¨‹ï¼Ÿ")){
          state.items.splice(idx,1);
          save(); renderAll();
        }
      }
      if(act==="dup"){
        const it = JSON.parse(JSON.stringify(state.items[idx]));
        it.id = genId();
        state.items.splice(idx+1, 0, it);
        save(); renderAll();
      }
    });

    // add form
    $("btnAdd").addEventListener("click", ()=>{
      const dateISO = norm($("fDateISO").value);
      if(!dateISO){
        alert("æ—¥æœŸä¸èƒ½ä¸ºç©º");
        return;
      }
      const it = {
        id: genId(),
        dateISO,
        date: isoToDisplay(dateISO),
        time: norm($("fTime").value),
        city: norm($("fCity").value),
        event: norm($("fEvent").value),
        venue: norm($("fVenue").value),
        ticketStatus: norm($("fTicket").value),
        transport: norm($("fTransport").value),
        transportStatus: norm($("fTransportStatus").value),
        seat: norm($("fSeat").value),
        lodging: norm($("fLodging").value),
        note: norm($("fNote").value)
      };
      state.items.push(it);
      save();
      renderAll();
      // small UX: scroll to bottom new item (sorted might move; so just focus search)
      $("q").focus();
    });
    $("btnClear").addEventListener("click", ()=>{
      ["fDateISO","fTime","fCity","fEvent","fVenue","fTransport","fSeat","fLodging","fNote"].forEach(id=>$(id).value="");
      $("fTicket").value="";
      $("fTransportStatus").value="";
    });

    // import/export/reset
    $("btnExportJson").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify({settings: state.settings, items: state.items}, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "genchi_plan_export.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $("btnImportJson").addEventListener("click", ()=> $("fileJson").click());
    $("fileJson").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const text = await f.text();
      try{
        const obj = JSON.parse(text);
        if(obj && obj.items){
          state.items = obj.items;
          state.settings = Object.assign(state.settings, obj.settings || {});
          save(); renderAll();
        }else{
          alert("JSON æ ¼å¼ä¸æ­£ç¡®ï¼ˆç¼ºå°‘ itemsï¼‰");
        }
      }catch(err){
        alert("æ— æ³•è§£æ JSON");
      }finally{
        e.target.value = "";
      }
    });

    $("btnReset").addEventListener("click", ()=>{
      if(confirm("å°†æ¸…ç©ºæœ¬åœ°ä¿å­˜å¹¶æ¢å¤åˆå§‹å¯¼å…¥ã€‚ç¡®å®šï¼Ÿ")){
        localStorage.removeItem(LS_KEY);
        location.reload();
      }
    });

    $("btnImportXlsx").addEventListener("click", ()=> $("fileXlsx").click());
    $("fileXlsx").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      // lightweight xlsx parser: use SheetJS via CDN not allowed offline; so we keep this button as "placeholder"
      alert("å½“å‰ç¦»çº¿å•æ–‡ä»¶ç‰ˆæœ¬ä¸å†…ç½® Excel è§£æåº“ã€‚å»ºè®®ï¼šå…ˆåœ¨ç”µè„‘ä¸Šå¯¼å‡ºä¸º JSON å†å¯¼å…¥ï¼ˆæˆ‘ä¹Ÿå¯ä»¥æŠŠ SheetJS å†…ç½®è¿›å•æ–‡ä»¶é‡Œï¼‰ã€‚");
      e.target.value="";
    });
  }

  // init
  load();
  bind();
  renderAll();
  setSavePill("localStorage: å·²åŠ è½½");
})();
</script>
</body>
</html>
